<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Aplicação</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./style-core.css">
    <link rel="stylesheet" href="./dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="Logo" class="logo"> <!-- Adicione um logo se tiver -->
            <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
        </div>
        <nav class="sidebar-nav">
            <a href="#" onclick="showPage('financas')" data-tooltip="Finanças">F</a>
            <a href="#" onclick="showPage('minhas-financas')" data-tooltip="Minhas Finanças">MF</a>
            <a href="#" onclick="showPage('perfil')" data-tooltip="Perfil">P</a>
        </nav>
        <div class="sidebar-footer">
            <a href="#" onclick="logout()" data-tooltip="Sair">S</a>
        </div>
        <!-- Sidebar footer se necessário -->
    </div>
    <div class="content" id="content">
        <div id="financas" class="page-section active">
            <div class="chat-container">
                <!-- Frase de prompt financeiro -->
                <div class="finance-prompt">
                    Pergunte Sobre suas finanças
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- Mensagens do chat aparecerão aqui -->
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">Enviar</button>
                </div>
            </div>
        </div>
        <div id="minhas-financas" class="page-section">
            <div class="subpage-header">
                <button onclick="showSubPage('minhas-financas-content')" class="subpage-btn active">Minhas Finanças</button>
                <button onclick="showSubPage('dashboard-content')" class="subpage-btn">Dashboard</button>
                <div class="month-selector">
                    <button onclick="previousMonth()">◀ Mês Anterior</button>
                    <span id="current-month-display">Mês Atual</span>
                    <button onclick="nextMonth()">Mês Próximo ▶</button>
                </div>
            </div>
            <div id="minhas-financas-content" class="subpage active">
    <div class="financas-section">
                    <h2>Minhas Finanças</h2>
                    <div class="dashboard">
                        <div class="dashboard-card">
                            <h3>Saldo Líquido</h3>
                            <p id="saldo-liquido">R$ 0,00</p>
                        </div>
                        <div class="dashboard-card">
                            <h3>Total Receitas</h3>
                            <p id="total-receitas">R$ 0,00</p>
                        </div>
                        <div class="dashboard-card">
                            <h3>Total Despesas</h3>
                            <p id="total-despesas">R$ 0,00</p>
                        </div>
                        
                    </div>
                    <div class="dashboard-extra">
                        <div class="recent-transactions">
                           
                            <ul id="recent-list">
                                <!-- Itens serão adicionados dinamicamente -->
                            </ul>
                        </div>
                    </div>
                    <datalist id="categories-list"></datalist>
                    <div class="spreadsheets">
                        <div class="spreadsheet-group">
                            <div class="spreadsheet">
                                <h3>Receitas Recorrentes</h3>
                                <table id="receitas-recorrentes-table">
                                    <thead>
                                        <tr>
                                            <th>Data <select id="filter-select-date-receitas-recorrentes" class="filter-select" data-table="receitas-recorrentes" data-column="date" style="display:none;">
                <option value="date-desc">Mais Recente</option>
                <option value="date-asc">Mais Antigo</option>
            </select> <i id="filter-icon-date-receitas-recorrentes" class="fas fa-chevron-down filter-icon" data-table="receitas-recorrentes" data-column="date" style="cursor:pointer;"></i></th>
                                            <th>Status</th>
                                            <th>Descrição</th>
                                            <th>Valor <select id="filter-select-value-receitas-recorrentes" class="filter-select" data-table="receitas-recorrentes" data-column="value" style="display:none;">
                <option value="value-desc">Maiores Valores</option>
                <option value="value-asc">Menores Valores</option>
            </select> <i id="filter-icon-value-receitas-recorrentes" class="fas fa-chevron-down filter-icon" data-table="receitas-recorrentes" data-column="value" style="cursor:pointer;"></i></th>
                                            <th>Categoria</th>
                                            <th>Subcategoria</th>
                                            <th>Notas</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Linhas serão adicionadas dinamicamente -->
                                    </tbody>
                                </table>
                                <button onclick="addRow('receitas-recorrentes')">Adicionar Receita Recorrente</button>
                            </div>
                            <div class="spreadsheet">
                                <h3>Receitas Variáveis</h3>
                                <table id="receitas-variaveis-table">
                                    <thead>
                                        <tr>
                                            <th>Data <select id="filter-select-date-receitas-variaveis" class="filter-select" data-table="receitas-variaveis" data-column="date" style="display:none;">
                <option value="date-desc">Mais Recente</option>
                <option value="date-asc">Mais Antigo</option>
            </select> <i id="filter-icon-date-receitas-variaveis" class="fas fa-chevron-down filter-icon" data-table="receitas-variaveis" data-column="date" style="cursor:pointer;"></i></th>
                                            <th>Status</th>
                                            <th>Fonte</th>
                                            <th>Valor <select id="filter-select-value-receitas-variaveis" class="filter-select" data-table="receitas-variaveis" data-column="value" style="display:none;">
                <option value="value-desc">Maiores Valores</option>
                <option value="value-asc">Menores Valores</option>
            </select> <i id="filter-icon-value-receitas-variaveis" class="fas fa-chevron-down filter-icon" data-table="receitas-variaveis" data-column="value" style="cursor:pointer;"></i></th>
                                            <th>Categoria</th>
                                            <th>Subcategoria</th>
                                            <th>Notas</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Linhas serão adicionadas dinamicamente -->
                                    </tbody>
                                </table>
                                <button onclick="addRow('receitas-variaveis')">Adicionar Receita Variável</button>
                            </div>
                        </div>
                        <div class="spreadsheet-group">
                            <div class="spreadsheet">
                                <h3>Despesas Fixas</h3>
                                <table id="despesas-fixas-table">
                                    <thead>
                                        <tr>
                                            <th>Data <select id="filter-select-date-despesas-fixas" class="filter-select" data-table="despesas-fixas" data-column="date" style="display:none;">
                <option value="date-desc">Mais Recente</option>
                <option value="date-asc">Mais Antigo</option>
            </select> <i id="filter-icon-date-despesas-fixas" class="fas fa-chevron-down filter-icon" data-table="despesas-fixas" data-column="date" style="cursor:pointer;"></i></th>
                                            <th>Status</th>
                                            <th>Descrição</th>
                                            <th>Categoria</th>
                                            <th>Subcategoria</th>
                                            <th>Valor <select id="filter-select-value-despesas-fixas" class="filter-select" data-table="despesas-fixas" data-column="value" style="display:none;">
                <option value="value-desc">Maiores Valores</option>
                <option value="value-asc">Menores Valores</option>
            </select> <i id="filter-icon-value-despesas-fixas" class="fas fa-chevron-down filter-icon" data-table="despesas-fixas" data-column="value" style="cursor:pointer;"></i></th>
                                            <th>Método</th>
                                            <th>Notas</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Linhas serão adicionadas dinamicamente -->
                                    </tbody>
                                </table>
                                <button onclick="addRow('despesas-fixas')">Adicionar Despesa Fixa</button>
                            </div>
                            <div class="spreadsheet">
                                <h3>Despesas Variáveis</h3>
                                <table id="despesas-variaveis-table">
                                    <thead>
                                        <tr>
                                            <th>Data <select id="filter-select-date-despesas-variaveis" class="filter-select" data-table="despesas-variaveis" data-column="date" style="display:none;">
                <option value="date-desc">Mais Recente</option>
                <option value="date-asc">Mais Antigo</option>
            </select> <i id="filter-icon-date-despesas-variaveis" class="fas fa-chevron-down filter-icon" data-table="despesas-variaveis" data-column="date" style="cursor:pointer;"></i></th>
                                            <th>Status</th>
                                            <th>Descrição</th>
                                            <th>Categoria</th>
                                            <th>Subcategoria</th>
                                            <th>Valor <select id="filter-select-value-despesas-variaveis" class="filter-select" data-table="despesas-variaveis" data-column="value" style="display:none;">
                <option value="value-desc">Maiores Valores</option>
                <option value="value-asc">Menores Valores</option>
            </select> <i id="filter-icon-value-despesas-variaveis" class="fas fa-chevron-down filter-icon" data-table="despesas-variaveis" data-column="value" style="cursor:pointer;"></i></th>
                                            <th>Método</th>
                                            <th>Notas</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Linhas serão adicionadas dinamicamente -->
                                    </tbody>
                                </table>
                                <button onclick="addRow('despesas-variaveis')">Adicionar Despesa Variável</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dashboard-content" class="subpage">
                <div class="dashboard-page">
                    <!-- Cards Superiores -->
                    <div class="dashboard-summary-cards">
                        <div class="dashboard-summary-card">
                            <h4>Saldo Líquido</h4>
                            <p id="dash-saldo-liquido">R$ 0,00</p>
                        </div>
                        <div class="dashboard-summary-card">
                            <h4>Total Receitas</h4>
                            <p id="dash-total-receitas">R$ 0,00</p>
                        </div>
                        <div class="dashboard-summary-card">
                            <h4>Total Despesas</h4>
                            <p id="dash-total-despesas">R$ 0,00</p>
                        </div>
                        <div class="dashboard-summary-card patrimonio-card" id="patrimonio-card">
                            <h4>Patrimônio</h4>
                            <p id="dash-patrimonio-total">R$ 0,00</p>
                            <div class="patrimonio-tooltip" id="patrimonio-tooltip">
                                <table class="patrimonio-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patrimonio-tooltip-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Linha com Receitas e Despesas -->
                    <div class="dashboard-row">
                        <!-- Principais Fontes de Receita -->
                        <div class="dashboard-block">
                            <div class="dashboard-block-header">
                                <h3>Principais Fontes de Receita</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <div id="receitas-categorias" class="categorias-list">
                                    <!-- Categorias serão adicionadas dinamicamente -->
                                </div>
                                <div class="dashboard-totals">
                                    <div class="dashboard-total-item">
                                        <span>Receita Recorrente:</span>
                                        <span id="receita-recorrente-total">R$ 0,00</span>
                                    </div>
                                    <div class="dashboard-total-item">
                                        <span>Receita Variável:</span>
                                        <span id="receita-variavel-total">R$ 0,00</span>
                                    </div>
                                    <div class="dashboard-total-item total-final">
                                        <span>Total Geral:</span>
                                        <span id="receita-total-geral">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Principais Fontes de Despesa -->
                        <div class="dashboard-block">
                            <div class="dashboard-block-header">
                                <h3>Principais Fontes de Despesa</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <div id="despesas-categorias" class="categorias-list">
                                    <!-- Categorias serão adicionadas dinamicamente -->
                                </div>
                                <div class="dashboard-totals">
                                    <div class="dashboard-total-item">
                                        <span>Despesa Fixa:</span>
                                        <span id="despesa-fixa-total">R$ 0,00</span>
                                    </div>
                                    <div class="dashboard-total-item">
                                        <span>Despesa Variável:</span>
                                        <span id="despesa-variavel-total">R$ 0,00</span>
                                    </div>
                                    <div class="dashboard-total-item total-final">
                                        <span>Total Geral:</span>
                                        <span id="despesa-total-geral">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha com Gráficos de Rosca de Receitas e Despesas -->
                    <div class="dashboard-row">
                        <!-- Gráfico de Distribuição de Receitas -->
                        <div class="dashboard-block dashboard-chart-block">
                            <div class="dashboard-block-header">
                                <h3>Distribuição de Receitas</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <canvas id="receitas-pie-chart"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico de Distribuição de Despesas -->
                        <div class="dashboard-block dashboard-chart-block">
                            <div class="dashboard-block-header">
                                <h3>Distribuição de Despesas</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <canvas id="despesas-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Linha com Gráfico de Subcategorias de Receitas e Despesas -->
                    <div class="dashboard-row">
                        <!-- Gráfico de Distribuição de Subcategorias de Receitas -->
                        <div class="dashboard-block dashboard-chart-block">
                            <div class="dashboard-block-header">
                                <h3>Distribuição de Subcategorias de Receitas</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <canvas id="subcategorias-receitas-chart"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico de Distribuição de Subcategorias de Despesas -->
                        <div class="dashboard-block dashboard-chart-block">
                            <div class="dashboard-block-header">
                                <h3>Distribuição de Subcategorias de Despesas</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <canvas id="subcategorias-despesas-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Linha com Objetivos e Dívidas -->
                    <div class="dashboard-row">
                        <!-- Objetivos Financeiros -->
                        <div class="dashboard-block">
                            <div class="dashboard-block-header">
                                <h3>Objetivos Financeiros</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <div id="objetivos-list" class="objetivos-list">
                                    <!-- Objetivos serão adicionados dinamicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Dívidas e Parcelamentos -->
                        <div class="dashboard-block">
                            <div class="dashboard-block-header">
                                <h3>Dívidas e Parcelamentos</h3>
                            </div>
                            <div class="dashboard-block-content">
                                <div id="dividas-dashboard-list" class="dividas-dashboard-list">
                                    <!-- Dívidas serão adicionadas dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Blocos de Anotações e Frases Motivacionais -->
                    <div class="dashboard-bottom-row">
                        <!-- Bloco de Anotações -->
                        <div class="dashboard-notes-container">
                            <div class="dashboard-block dashboard-notes-block">
                                <div class="dashboard-block-header">
                                    <h3>Anotações</h3>
                                    <span class="notes-subtitle">Página <span id="current-page-number">1</span></span>
                                </div>
                                <div class="dashboard-block-content">
                                    <div class="notes-page" id="notes-page-container">
                                        <div class="notes-line"><input type="text" class="notes-input" data-page="1" data-line="1" placeholder=""></div>
                                        <div class="notes-line"><input type="text" class="notes-input" data-page="1" data-line="2" placeholder=""></div>
                                        <div class="notes-line"><input type="text" class="notes-input" data-page="1" data-line="3" placeholder=""></div>
                                        <div class="notes-line"><input type="text" class="notes-input" data-page="1" data-line="4" placeholder=""></div>
                                        <div class="notes-line"><input type="text" class="notes-input" data-page="1" data-line="5" placeholder=""></div>
                                    </div>
                                    <div class="notes-navigation">
                                        <button class="notes-nav-btn" id="prev-page-btn" onclick="previousNotesPage()" style="visibility: hidden;">
                                            ← Página Anterior
                                        </button>
                                        <button class="notes-nav-btn" id="next-page-btn" onclick="nextNotesPage()">
                                            Próxima Página →
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bloco de Frases Motivacionais -->
                        <div class="dashboard-motivational-container">
                            <div class="dashboard-block dashboard-motivational-block">
                                <div class="dashboard-block-header">
                                    <h3>Frase do Dia</h3>
                                </div>
                                <div class="dashboard-block-content">
                                    <div class="motivational-quote" id="motivational-quote">
                                        <blockquote class="quote-text" id="quote-text"></blockquote>
                                        <cite class="quote-author" id="quote-author"></cite>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="perfil" class="page-section">
            <div class="profile-container">
                <h1>Perfil</h1>
                <div class="profile-sections">
                    <div class="profile-section">
                        <h2>Informações Pessoais</h2>
                        <label for="nome">Nome completo:</label>
                        <input type="text" id="nome" placeholder="Digite seu nome">
                        
                        <label for="idade">Idade:</label>
                        <input type="number" id="idade" placeholder="Digite sua idade">
                        
                        <label for="profissao">Profissão/Ocupação:</label>
                        <input type="text" id="profissao" placeholder="Digite sua profissão">
                        
                        <label for="localizacao">Localização:</label>
                        <input type="text" id="localizacao" placeholder="Cidade/Estado">
                        
                        <label for="contato">Email ou telefone:</label>
                        <input type="text" id="contato" placeholder="Digite seu email ou telefone">
                        
                        <label for="sobre-voce">Conte-nos mais sobre você:</label>
                        <textarea id="sobre-voce" placeholder="Compartilhe sua história financeira, perspectivas, desafios, sonhos e o que você espera alcançar usando esta plataforma. Quanto mais você compartilhar, melhor poderemos ajudá-lo!" rows="6" style="width: 100%; padding: var(--spacing-sm); margin-bottom: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-background); color: var(--color-text-primary); box-sizing: border-box; resize: vertical; font-family: 'Poppins', sans-serif; font-size: 0.9em;"></textarea>
                        
                        <button onclick="saveSection('pessoal')">Salvar Informações Pessoais</button>
                    </div>
                    
                    <div class="profile-section">
                        <h2>Situação Financeira Atual</h2>
                        
                        <label for="saldo-conta">Saldo em conta corrente/poupança:</label>
                        <input type="text" id="saldo-conta" placeholder="R$ 0,00" oninput="formatCurrency(this)">
                        
                        <label for="ativos">Patrimônio:</label>
                        <div class="patrimonio-container">
                            <div class="patrimonio-header">
                                <span>Descrição</span>
                                <span>Valor</span>
                                <span>Ações</span>
                            </div>
                            <div class="patrimonio-list" id="patrimonio-list">
                                <!-- Linhas de patrimônio serão adicionadas dinamicamente -->
                            </div>
                            <button class="add-patrimonio-btn" onclick="addPatrimonio()">Adicionar Patrimônio</button>
                            <div class="patrimonio-total">
                                <label>Total do Patrimônio:</label>
                                <span id="patrimonio-total">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <label for="dependentes">Dependentes (quantas pessoas dependem dessa renda?)</label>
                        <input type="number" id="dependentes" placeholder="Ex: 2">
                        
                        <label for="modelo-renda">Modelo de renda (CLT, PJ, autônomo, renda variável?)</label>
                        <input type="text" id="modelo-renda" placeholder="Digite o modelo de renda">
                        
                        <button onclick="saveSection('financeira')">Salvar Situação Financeira</button>
                    </div>
                    
                    <div class="profile-section">
                        <h2>Objetivos Financeiros</h2>
                        <label for="poupanca-mensal">Meta de poupança mensal:</label>
                        <input type="text" id="poupanca-mensal" placeholder="R$ 0,00" oninput="formatCurrency(this)">
                        
                        <label for="fundo-emergencia">Fundo de emergência desejado:</label>
                        <input type="text" id="fundo-emergencia" placeholder="R$ 0,00" oninput="formatCurrency(this)">
                        
                        <label for="prazo-emergencia">Prazo para fundo de emergência:</label>
                        <input type="text" id="prazo-emergencia" placeholder="Ex.: 6 meses">
                        
                        <label for="investimento-mensal">Meta de investimento mensal:</label>
                        <input type="text" id="investimento-mensal" placeholder="R$ 0,00" oninput="formatCurrency(this)">
                        
                        <label for="meta-longo-prazo">Meta de longo prazo:</label>
                        <input type="text" id="meta-longo-prazo" placeholder="Ex.: Comprar casa">
                        
                        <label for="valor-meta-longo">Valor estimado para meta de longo prazo:</label>
                        <input type="text" id="valor-meta-longo" placeholder="R$ 0,00" oninput="formatCurrency(this)">
                        
                        <label for="prazo-meta-longo">Prazo para meta de longo prazo:</label>
                        <input type="text" id="prazo-meta-longo" placeholder="Ex.: 5 anos">
                        
                        <button onclick="saveSection('objetivos')">Salvar Objetivos Financeiros</button>
                    </div>

                    <div class="profile-section">
                        <h2>Dívidas e Parcelamentos Ativos</h2>
                        <div class="dividas-header">
                            <div class="dividas-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Total em Dívidas:</span>
                                    <span class="summary-value" id="total-dividas">R$ 0,00</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Parcelas Mensais:</span>
                                    <span class="summary-value" id="parcelas-mensais">R$ 0,00</span>
                                </div>
                            </div>
                            <button onclick="openDividaModal()" class="add-divida-btn">Adicionar Divida</button>
                        </div>
                        <div id="dividas-list" class="dividas-list">
                            <!-- Dívidas serão adicionadas dinamicamente -->
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Adicione este código ao final do <body> no arquivo index.html (ou equivalente) -->
<div id="login-modal" style="display: none;">
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-left">
                <!-- Área para foto: substitua pela sua imagem -->
                <img src="path/to/your/image.jpg" alt="Imagem de login" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="modal-right">
                <h2 id="modal-title">Login ou Cadastro</h2>
                <form id="login-form">
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="password" id="password" placeholder="Senha" required>
                    <!-- Campos extras para cadastro, ocultos inicialmente -->
                    <div id="extra-fields" style="display: none;">
                        <input type="text" id="modal-nome" placeholder="Nome completo">
                        <input type="text" id="modal-nascimento" placeholder="Data de nascimento">
                        <input type="text" id="modal-contato" placeholder="Contato">
                    </div>
                    <button type="submit" id="submit-btn">Entrar</button>
                    <button type="button" id="register-btn">Cadastrar</button>
                    <button type="button" id="login-btn" style="display: none;">Voltar ao Login</button>
                </form>
                <div id="message"></div>
            </div>
        </div>
    </div>
</div>

<!-- Botão flutuante para IA -->
<button id="ai-float-btn" style="position: fixed; bottom: 20px; right: 20px; padding: 12px 16px; background: var(--color-primary); color: var(--color-background); border: none; border-radius: 50px; cursor: pointer; box-shadow: var(--shadow-lg); z-index: 1000; font-size: 14px;">Peça para a IA</button>

<!-- Modal de IA -->
<div id="ai-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-surface); padding: var(--spacing-lg); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 1000; max-width: 500px; width: 90%; text-align: center;">
    <h3 id="modal-title">Selecione a Planilha</h3>
    <p id="modal-desc">Escolha em qual tabela você deseja adicionar a transação para que a IA possa processar corretamente.</p>
    <select id="table-select" style="width: 100%; padding: var(--spacing-sm); margin-bottom: var(--spacing-md);">
        <option value="">Selecione a tabela</option>
        <option value="receitas-recorrentes">Receitas Recorrentes</option>
        <option value="receitas-variaveis">Receitas Variáveis</option>
        <option value="despesas-fixas">Despesas Fixas</option>
        <option value="despesas-variaveis">Despesas Variáveis</option>
    </select>
    <div id="input-section" style="display: none;">
        <textarea id="ai-description" placeholder="Digite aqui..." style="width: 100%; padding: var(--spacing-xs); margin-bottom: var(--spacing-md); resize: vertical; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-background); color: var(--color-text-primary); font-size: 0.9em; height: 150px; box-sizing: border-box;"></textarea>
        <div class="button-container">
            <button id="ai-submit">Enviar para IA</button>
            <button id="close-modal">Fechar</button>
        </div>
        <div id="ai-loading" style="display: none; margin-top: var(--spacing-md);">Processando com IA...</div>
    </div>
</div>

<!-- Modal de Dívidas -->
<div id="divida-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeDividaModal()"></div>
    <div class="modal-content divida-modal-content">
        <div class="divida-modal-header">
            <h3 id="divida-modal-title">Adicionar Dívida</h3>
            <button onclick="closeDividaModal()" class="close-modal-btn">&times;</button>
        </div>
        <form id="divida-form" class="divida-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="divida-nome">Nome da Dívida *</label>
                    <input type="text" id="divida-nome" required placeholder="Ex: Empréstimo Banco X">
                </div>
                <div class="form-group">
                    <label for="divida-tipo">Tipo *</label>
                    <select id="divida-tipo" required>
                        <option value="">Selecione o tipo</option>
                        <option value="emprestimo">Empréstimo</option>
                        <option value="financiamento">Financiamento</option>
                        <option value="cartao">Cartão de Crédito</option>
                        <option value="consignado">Consignado</option>
                        <option value="cheque">Cheque Especial</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="divida-valor-total">Valor Total *</label>
                    <input type="text" id="divida-valor-total" required placeholder="R$ 0,00" oninput="formatCurrency(this)">
                </div>
                <div class="form-group">
                    <label for="divida-parcelas">Parcelas Restantes *</label>
                    <input type="number" id="divida-parcelas" required placeholder="Ex: 12" min="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="divida-valor-parcela">Valor da Parcela *</label>
                    <input type="text" id="divida-valor-parcela" required placeholder="Calculado automaticamente" readonly>
                </div>
                <div class="form-group">
                    <label for="divida-dia-vencimento">Dia de Vencimento *</label>
                    <input type="number" id="divida-dia-vencimento" required min="1" max="31" placeholder="Ex: 10">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="divida-primeira-parcela">Data da Primeira Parcela *</label>
                    <input type="date" id="divida-primeira-parcela" required>
                </div>
                <div class="form-group">
                    <!-- Espaço vazio para manter o layout -->
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="save-divida-btn">Salvar Dívida</button>
                <button type="button" onclick="closeDividaModal()" class="cancel-btn">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Visualização de Parcelas -->
<div id="parcelas-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeParcelasModal()"></div>
    <div class="modal-content parcelas-modal-content">
        <div class="parcelas-modal-header">
            <h3 id="parcelas-modal-title">Parcelas</h3>
            <button onclick="closeParcelasModal()" class="close-modal-btn">&times;</button>
        </div>
        <div class="parcelas-modal-body">
            <div class="parcelas-info">
                <div class="parcelas-info-item">
                    <span class="parcelas-info-label">Valor Total</span>
                    <span class="parcelas-info-value" id="parcelas-valor-total">R$ 0,00</span>
                </div>
                <div class="parcelas-info-item">
                    <span class="parcelas-info-label">Valor Parcela</span>
                    <span class="parcelas-info-value" id="parcelas-valor-parcela">R$ 0,00</span>
                </div>
                <div class="parcelas-info-item">
                    <span class="parcelas-info-label">Progresso</span>
                    <span class="parcelas-info-value" id="parcelas-progresso">0/0</span>
                </div>
            </div>
            <div class="parcelas-list" id="parcelas-list-container">
                <!-- Parcelas serão adicionadas dinamicamente -->
            </div>
        </div>
    </div>
</div>


    <script src="./app.js"></script>
    <script src="./finance.js"></script>
    <script src="./dashboard.js"></script>
</body>
</html>

dashboard.css:
/* === DASHBOARD STYLES === */

.dashboard-page {
    padding: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    max-width: 1400px;
    margin: 0 auto;
}

/* Cards Superiores */
.dashboard-summary-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-md);
}

.dashboard-summary-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    text-align: center;
    transition: all var(--transition-fast);
}

.dashboard-summary-card:hover {
    border-color: rgba(255, 255, 255, 0.15);
    box-shadow: var(--shadow-sm);
}

.dashboard-summary-card h4 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 0.85em;
    font-weight: 500;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.dashboard-summary-card p {
    margin: 0;
    font-size: 1.5em;
    font-weight: 700;
    color: var(--color-text-primary);
}

/* Tooltip personalizado do Patrimônio */
.patrimonio-card {
    position: relative;
    overflow: hidden; /* Garante que o conteúdo não saia do card */
}

.patrimonio-tooltip {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-xs);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
    z-index: 10;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    box-sizing: border-box;
    overflow: hidden;
}

.patrimonio-card:hover .patrimonio-tooltip {
    opacity: 1;
    visibility: visible;
}

.patrimonio-card:hover p {
    opacity: 0;
    visibility: hidden;
}

.patrimonio-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75em; /* Aumentado em 1px (aproximadamente) */
    line-height: 1.2;
}

.patrimonio-table th,
.patrimonio-table td {
    padding: 1px 2px; /* Padding mínimo */
    text-align: left;
    border-bottom: 1px solid var(--color-border);
    font-size: inherit;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 80px; /* Limita largura das células */
}

.patrimonio-table th {
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.7em; /* Ajustado proporcionalmente */
    padding-bottom: 2px;
}

.patrimonio-table td {
    color: var(--color-text-primary);
    font-weight: 500;
}

/* Blocos do Dashboard */
.dashboard-block {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.dashboard-block-header {
    padding: var(--spacing-md) var(--spacing-lg);
    border-bottom: 1px solid var(--color-border);
    background: rgba(255, 255, 255, 0.02);
}

.dashboard-block-header h3 {
    margin: 0;
    font-size: 1em;
    font-weight: 600;
    color: var(--color-text-primary);
}

.dashboard-block-content {
    padding: var(--spacing-lg);
}

/* Linha com dois blocos lado a lado */
.dashboard-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
}

.dashboard-chart-block,
.dashboard-status-block {
    min-height: 300px;
}

/* Lista de Categorias */
.categorias-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.categoria-item {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: rgba(255, 255, 255, 0.02);
    overflow: hidden;
}

.categoria-header {
    padding: var(--spacing-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background var(--transition-fast);
}

.categoria-header:hover {
    background: rgba(255, 255, 255, 0.03);
}

.categoria-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex: 1;
}

.categoria-nome {
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: 0.95em;
}

.categoria-valor {
    font-weight: 600;
    color: var(--color-text-primary);
    margin-right: var(--spacing-sm);
}

.categoria-percent {
    font-size: 0.85em;
    color: var(--color-text-secondary);
}

.categoria-bar-container {
    flex: 1;
    max-width: 200px;
    height: 8px;
    background: var(--color-surface-elevated);
    border-radius: 4px;
    overflow: hidden;
}

.categoria-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
    border-radius: 4px;
    transition: width var(--transition-base);
}

.categoria-expand-icon {
    color: var(--color-text-secondary);
    font-size: 0.9em;
    transition: transform var(--transition-fast);
}

.categoria-item.expanded .categoria-expand-icon {
    transform: rotate(180deg);
}

/* Subcategorias */
.subcategorias-list {
    padding: var(--spacing-sm) var(--spacing-md) var(--spacing-md) var(--spacing-md);
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid var(--color-border);
    display: none;
}

.categoria-item.expanded .subcategorias-list {
    display: block;
}

.subcategoria-item {
    padding: var(--spacing-sm) var(--spacing-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    border-left: 2px solid rgba(255, 255, 255, 0.1);
    margin-bottom: var(--spacing-xs);
}

.subcategoria-nome {
    color: var(--color-text-secondary);
}

.subcategoria-valor {
    color: var(--color-text-primary);
    font-weight: 500;
}

/* Botão Ver Mais */
.ver-mais-btn {
    margin-top: var(--spacing-sm);
    width: 100%;
    padding: var(--spacing-sm);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    font-size: 0.9em;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.ver-mais-btn:hover {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.15);
    color: var(--color-text-primary);
}

/* Totais */
.dashboard-totals {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.dashboard-total-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    color: var(--color-text-secondary);
}

.dashboard-total-item.total-final {
    font-size: 1em;
    font-weight: 600;
    color: var(--color-text-primary);
    padding-top: var(--spacing-sm);
    border-top: 1px solid var(--color-border);
}

/* Gráfico */
#distribution-chart,
#subcategorias-receitas-chart,
#subcategorias-despesas-chart {
    max-width: 300px;
    max-height: 300px;
    margin: 0 auto;
}

#receitas-pie-chart,
#despesas-pie-chart {
    max-width: 300px;
    max-height: 300px;
    margin: 0 auto;
}

/* Situação Financeira */
.financial-status-item {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--color-border);
}

.financial-status-item:last-child {
    border-bottom: none;
}

.financial-status-item.highlight {
    padding-top: var(--spacing-lg);
    border-top: 2px solid var(--color-border);
}

.status-label {
    font-size: 0.9em;
    color: var(--color-text-secondary);
}

.status-value {
    font-size: 1.1em;
    font-weight: 600;
    color: var(--color-text-primary);
}

.financial-status-item.highlight .status-value {
    font-size: 1.3em;
    font-weight: 700;
}

/* Objetivos Financeiros */
.objetivos-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.objetivo-item {
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: rgba(255, 255, 255, 0.02);
}

.objetivo-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.objetivo-nome {
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: 0.95em;
}

.objetivo-percent {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 1em;
}

.objetivo-progress-bar {
    height: 8px;
    background: var(--color-surface-elevated);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--spacing-xs);
}

.objetivo-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
    border-radius: 4px;
    transition: width var(--transition-base);
}

.objetivo-valores {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    color: var(--color-text-secondary);
}

.objetivo-empty {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-secondary);
    font-size: 0.9em;
}

/* Dívidas Dashboard */
.dividas-dashboard-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.divida-dashboard-item {
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-left: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-sm);
    background: rgba(255, 255, 255, 0.02);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.divida-dashboard-info {
    flex: 1;
}

.divida-dashboard-nome {
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: 0.95em;
    margin-bottom: var(--spacing-xs);
}

.divida-dashboard-detalhes {
    font-size: 0.85em;
    color: var(--color-text-secondary);
}

.divida-dashboard-valor {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 1em;
}

.dividas-empty {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-secondary);
    font-size: 0.9em;
}

/* Bloco de Frases Motivacionais */
.dashboard-motivational-container {
    flex: 0 0 35%;
}

.dashboard-motivational-block {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    height: 100%;
}

.motivational-quote {
    text-align: center;
    padding: var(--spacing-md);
}

.quote-text {
    font-style: italic;
    font-size: 1.375em; /* Aumentado 25% de 1.1em */
    font-weight: 200; /* Fonte mais leve para delicadeza */
    color: var(--color-text-primary);
    line-height: 1.4;
    margin: 0 0 var(--spacing-md) 0;
    position: relative;
    font-family: 'Poppins', sans-serif; /* Fonte mais elegante */
}

.quote-text:before {
    content: '"';
    font-size: 2em;
    color: var(--color-text-secondary);
    position: absolute;
    left: -15px;
    top: -5px;
}

.quote-text:after {
    content: '"';
    font-size: 2em;
    color: var(--color-text-secondary);
    position: absolute;
    right: -15px;
    bottom: -15px;
}

.quote-author {
    font-style: italic;
    font-size: 0.9em;
    font-weight: 300; /* Mais leve também */
    color: var(--color-text-secondary);
    border-top: 1px solid var(--color-border);
    padding-top: var(--spacing-sm);
    display: block;
    margin-top: var(--spacing-md);
    font-family: 'Poppins', sans-serif;
}

.notes-subtitle {
    font-size: 0.85em;
    color: var(--color-text-secondary);
    font-weight: 400;
}

.notes-page {
    padding: var(--spacing-md) 0;
}

.notes-line {
    position: relative;
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-xs);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.notes-input {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    color: var(--color-text-primary);
    font-family: 'Poppins', sans-serif;
    font-size: 0.95em;
    padding: var(--spacing-xs) 0;
    line-height: 1.5;
}

.notes-input::placeholder {
    color: transparent;
}

.notes-input:focus {
    background: rgba(255, 255, 255, 0.02);
}

.notes-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--color-border);
}

.notes-nav-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    font-size: 0.9em;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: 'Poppins', sans-serif;
}

.notes-nav-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--color-text-primary);
}

.notes-nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

/* Container para anotações e frases lado a lado */
.dashboard-bottom-row {
    display: flex;
    gap: var(--spacing-lg);
    align-items: flex-start;
}

/* Bloco de Anotações */
.dashboard-notes-container {
    flex: 1;
}

.dashboard-notes-block {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
}

/* Frase de prompt financeiro */
.finance-prompt {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5em;
    font-weight: 300;
    color: var(--color-text-primary);
    text-align: center;
    pointer-events: none; /* Para não interferir com cliques */
    z-index: 10; /* Para ficar acima de outros elementos */
}

/* Responsividade */
@media (max-width: 1024px) {
    .dashboard-row {
        grid-template-columns: 1fr;
    }

    .categoria-bar-container {
        max-width: 150px;
    }
    
    .dashboard-bottom-row {
        flex-direction: column;
    }

    .dashboard-notes-container {
        margin-right: 0;
        margin-bottom: var(--spacing-lg);
    }

    .dashboard-motivational-container {
        flex: none;
        width: 100%;
    }
}

@media (max-width: 768px) {
    .dashboard-summary-cards {
        grid-template-columns: 1fr;
    }

    .categoria-info {
        flex-wrap: wrap;
    }

    .categoria-bar-container {
        width: 100%;
        max-width: none;
        order: 3;
        margin-top: var(--spacing-xs);
    }
}

dashboard.js:
// === DASHBOARD FUNCTIONS ===

// Frases motivacionais
const motivationalQuotes = [
    {
        text: "O sucesso é a soma de pequenos esforços repetidos dia após dia.",
        author: "Robert Collier"
    },
    {
        text: "Não espere por oportunidades extraordinárias. Agarre as oportunidades comuns e as torne extraordinárias.",
        author: "Orison Swett Marden"
    },
    {
        text: "A disciplina é a ponte entre metas e conquistas.",
        author: "Jim Rohn"
    },
    {
        text: "O investimento em conhecimento rende os melhores juros.",
        author: "Benjamin Franklin"
    },
    {
        text: "O dinheiro é um bom servo, mas um mau mestre.",
        author: "Francis Bacon"
    },
    {
        text: "Riqueza é o resultado de decisões corretas tomadas consistentemente ao longo do tempo.",
        author: "Tony Robbins"
    },
    {
        text: "Não economize o que sobra depois de gastar, mas gaste o que sobra depois de economizar.",
        author: "Warren Buffett"
    },
    {
        text: "O primeiro passo para sair da pobreza é decidir que você merece ser rico.",
        author: "Louise Hay"
    },
    {
        text: "A paciência é amarga, mas seus frutos são doces.",
        author: "Aristóteles"
    },
    {
        text: "O futuro depende do que você faz hoje.",
        author: "Mahatma Gandhi"
    }
];

// Função para obter frase motivacional do dia
function getDailyMotivationalQuote() {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
    const quoteIndex = dayOfYear % motivationalQuotes.length;
    return motivationalQuotes[quoteIndex];
}

// Função para atualizar frase motivacional
function updateMotivationalQuote() {
    const quote = getDailyMotivationalQuote();
    const quoteTextElement = document.getElementById('quote-text');
    const quoteAuthorElement = document.getElementById('quote-author');

    if (quoteTextElement && quoteAuthorElement) {
        quoteTextElement.textContent = quote.text;
        quoteAuthorElement.textContent = `— ${quote.author}`;
    }
}

let dashboardChart = null;
let receitasPieChart = null;
let despesasPieChart = null;
let subcategoriasReceitasChart = null;
let subcategoriasDespesasChart = null;

// Atualizar dashboard completo
function updateFullDashboard() {
    console.log('🎯 Atualizando dashboard completo...');
    updateDashboardSummary();
    updateReceitasCategorias();
    updateDespesasCategorias();
    updateReceitasPieChart();
    updateDespesasPieChart();
    updateSubcategoriasReceitasChart();
    updateSubcategoriasDespesasChart();
    updateObjetivosFinanceiros();
    updateDividasDashboard();
    updateMotivationalQuote(); // Adicionar atualização da frase motivacional
    console.log('✅ Dashboard atualizado com sucesso!');
}

// Atualizar cards superiores
function updateDashboardSummary() {
    if (!window.userId) return;

    // Buscar transações do mês atual
    fetch(`http://localhost:3000/transactions/${window.userId}`)
    .then(response => response.json())
    .then(allTransactions => {
        // Filtrar transações do mês atual
        const monthTransactions = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && transDate.getFullYear() === window.currentMonth.getFullYear();
        });

        let totalReceitas = 0;
        let totalDespesas = 0;

        // Calcular totais das transações do mês
        monthTransactions.forEach(trans => {
            const valor = parseCurrency(trans.valor);
            if (trans.type === 'receitas') {
                totalReceitas += valor;
            } else {
                totalDespesas += valor;
            }
        });

        const saldoLiquidoTransacoes = totalReceitas - totalDespesas;

        // Buscar saldo da conta do perfil
        fetch(`http://localhost:3000/profile/${window.userId}`)
        .then(response => response.json())
        .then(profile => {
            const saldoConta = parseCurrency(profile.financeira?.saldoConta || '0');
            const saldoLiquido = saldoLiquidoTransacoes + saldoConta;

            // Calcular patrimônio total
            const patrimonioData = profile.financeira?.patrimonio || [];
            const patrimonioTotal = patrimonioData.reduce((sum, item) => {
                const valor = parseCurrency(item?.valor || '0');
                return sum + valor;
            }, 0);

            // Popular tabela do tooltip de patrimônio
            const patrimonioTooltipBody = document.getElementById('patrimonio-tooltip-body');
            if (patrimonioTooltipBody) {
                patrimonioTooltipBody.innerHTML = '';
                if (patrimonioData.length > 0) {
                    patrimonioData.forEach(item => {
                        const row = document.createElement('tr');
                        const valorNumerico = parseCurrency(item?.valor || '0');
                        const valorFormatado = formatCurrencyValue(valorNumerico);
                        row.innerHTML = `
                            <td>${item?.tipo || 'N/A'}</td>
                            <td>${valorFormatado}</td>
                        `;
                        patrimonioTooltipBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="2" style="text-align: center; color: var(--color-text-secondary); font-size: 0.7em;">Nenhum patrimônio cadastrado</td>
                    `;
                    patrimonioTooltipBody.appendChild(row);
                }
            }

            // Atualizar cards do dashboard
            const dashSaldo = document.getElementById('dash-saldo-liquido');
            const dashReceitas = document.getElementById('dash-total-receitas');
            const dashDespesas = document.getElementById('dash-total-despesas');
            const dashPatrimonio = document.getElementById('dash-patrimonio-total');

            if (dashSaldo) dashSaldo.textContent = formatCurrencyValue(saldoLiquido);
            if (dashReceitas) dashReceitas.textContent = formatCurrencyValue(totalReceitas);
            if (dashDespesas) dashDespesas.textContent = formatCurrencyValue(totalDespesas);
            if (dashPatrimonio) dashPatrimonio.textContent = formatCurrencyValue(patrimonioTotal);
        })
        .catch(error => {
            console.error('Erro ao carregar perfil para dashboard:', error);
            // Fallback sem saldo da conta
            const dashSaldo = document.getElementById('dash-saldo-liquido');
            const dashReceitas = document.getElementById('dash-total-receitas');
            const dashDespesas = document.getElementById('dash-total-despesas');

            if (dashSaldo) dashSaldo.textContent = formatCurrencyValue(saldoLiquidoTransacoes);
            if (dashReceitas) dashReceitas.textContent = formatCurrencyValue(totalReceitas);
            if (dashDespesas) dashDespesas.textContent = formatCurrencyValue(totalDespesas);
        });
    })
    .catch(error => {
        console.error('Erro ao carregar transações para dashboard:', error);
    });
}

// Atualizar receitas por categoria
function updateReceitasCategorias() {
    const container = document.getElementById('receitas-categorias');
    if (!container || !window.userId) return;

    // Buscar transações do mês atual
    fetch(`http://localhost:3000/transactions/${window.userId}`)
    .then(response => response.json())
    .then(allTransactions => {
        // Filtrar transações do mês atual e receitas
        const monthReceitas = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && 
                   transDate.getFullYear() === window.currentMonth.getFullYear() &&
                   trans.type === 'receitas';
        });

        const categorias = {};
        let totalRecorrente = 0;
        let totalVariavel = 0;

        monthReceitas.forEach(trans => {
            const categoria = trans.categoria || 'Sem categoria';
            const subcategoria = trans.subcategoria || 'Sem subcategoria';
            const valor = parseCurrency(trans.valor);
            const tipo = trans.subType === 'recorrente' ? 'recorrente' : 'variavel';

            if (valor > 0) {
                if (tipo === 'recorrente') totalRecorrente += valor;
                else totalVariavel += valor;

                if (!categorias[categoria]) {
                    categorias[categoria] = { total: 0, subcategorias: {}, tipo };
                }
                categorias[categoria].total += valor;
                if (!categorias[categoria].subcategorias[subcategoria]) {
                    categorias[categoria].subcategorias[subcategoria] = 0;
                }
                categorias[categoria].subcategorias[subcategoria] += valor;
            }
        });

        const totalGeral = totalRecorrente + totalVariavel;
        renderCategorias(container, categorias, totalGeral, 'receitas');

        // Atualizar totais
        document.getElementById('receita-recorrente-total').textContent = formatCurrencyValue(totalRecorrente);
        document.getElementById('receita-variavel-total').textContent = formatCurrencyValue(totalVariavel);
        document.getElementById('receita-total-geral').textContent = formatCurrencyValue(totalGeral);
    })
    .catch(error => {
        console.error('Erro ao carregar receitas para categorias:', error);
    });
}

// Atualizar despesas por categoria
function updateDespesasCategorias() {
    const container = document.getElementById('despesas-categorias');
    if (!container || !window.userId) return;

    // Buscar transações do mês atual
    fetch(`http://localhost:3000/transactions/${window.userId}`)
    .then(response => response.json())
    .then(allTransactions => {
        // Filtrar transações do mês atual e despesas
        const monthDespesas = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && 
                   transDate.getFullYear() === window.currentMonth.getFullYear() &&
                   trans.type === 'despesas';
        });

        const categorias = {};
        let totalFixa = 0;
        let totalVariavel = 0;

        monthDespesas.forEach(trans => {
            const categoria = trans.categoria || 'Sem categoria';
            const subcategoria = trans.subcategoria || 'Sem subcategoria';
            const valor = parseCurrency(trans.valor);
            const tipo = trans.subType === 'fixa' ? 'fixa' : 'variavel';

            if (valor > 0) {
                if (tipo === 'fixa') totalFixa += valor;
                else totalVariavel += valor;

                if (!categorias[categoria]) {
                    categorias[categoria] = { total: 0, subcategorias: {}, tipo };
                }
                categorias[categoria].total += valor;
                if (!categorias[categoria].subcategorias[subcategoria]) {
                    categorias[categoria].subcategorias[subcategoria] = 0;
                }
                categorias[categoria].subcategorias[subcategoria] += valor;
            }
        });

        const totalGeral = totalFixa + totalVariavel;
        renderCategorias(container, categorias, totalGeral, 'despesas');

        // Atualizar totais
        document.getElementById('despesa-fixa-total').textContent = formatCurrencyValue(totalFixa);
        document.getElementById('despesa-variavel-total').textContent = formatCurrencyValue(totalVariavel);
        document.getElementById('despesa-total-geral').textContent = formatCurrencyValue(totalGeral);
    })
    .catch(error => {
        console.error('Erro ao carregar despesas para categorias:', error);
    });
}

// Atualizar gráfico de rosca de receitas
function updateReceitasPieChart() {
    const canvas = document.getElementById('receitas-pie-chart');
    if (!canvas || !window.userId) return;

    const ctx = canvas.getContext('2d');

    // Buscar transações do mês atual
    fetch(`http://localhost:3000/transactions/${window.userId}`)
    .then(response => response.json())
    .then(allTransactions => {
        // Filtrar transações do mês atual e receitas
        const monthReceitas = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && 
                   transDate.getFullYear() === window.currentMonth.getFullYear() &&
                   trans.type === 'receitas';
        });

        // Coletar dados das categorias
        const categorias = {};
        let total = 0;

        monthReceitas.forEach(trans => {
            const categoria = trans.categoria || 'Sem categoria';
            const valor = parseCurrency(trans.valor);
            
            if (valor > 0 && categoria !== 'Selecione uma categoria' && categoria !== '') {
                categorias[categoria] = (categorias[categoria] || 0) + valor;
                total += valor;
            }
        });

        // Destruir gráfico anterior
        if (receitasPieChart) {
            receitasPieChart.destroy();
        }

        // Preparar dados
        const labels = Object.keys(categorias);
        const data = Object.values(categorias);
        const colors = labels.map((_, index) => `hsl(${(index * 137.5) % 360}, 70%, 50%)`);

        // Criar novo gráfico
        receitasPieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('50%', '30%')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#a0a0a0',
                            font: {
                                family: 'Poppins',
                                size: 11
                            },
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e1e1e',
                        titleColor: '#fff',
                        bodyColor: '#a0a0a0',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = formatCurrencyValue(context.raw);
                                const percent = ((context.raw / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Erro ao carregar receitas para gráfico:', error);
    });
}

// Atualizar gráfico de rosca de despesas
function updateDespesasPieChart() {
    const canvas = document.getElementById('despesas-pie-chart');
    if (!canvas || !window.userId) return;

    const ctx = canvas.getContext('2d');

    // Buscar transações do mês atual
    fetch(`http://localhost:3000/transactions/${window.userId}`)
    .then(response => response.json())
    .then(allTransactions => {
        // Filtrar transações do mês atual e despesas
        const monthDespesas = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && 
                   transDate.getFullYear() === window.currentMonth.getFullYear() &&
                   trans.type === 'despesas';
        });

        // Coletar dados das categorias
        const categorias = {};
        let total = 0;

        monthDespesas.forEach(trans => {
            const categoria = trans.categoria || 'Sem categoria';
            const valor = parseCurrency(trans.valor);
            
            if (valor > 0 && categoria !== 'Selecione uma categoria' && categoria !== '') {
                categorias[categoria] = (categorias[categoria] || 0) + valor;
                total += valor;
            }
        });

        // Destruir gráfico anterior
        if (despesasPieChart) {
            despesasPieChart.destroy();
        }

        // Preparar dados
        const labels = Object.keys(categorias);
        const data = Object.values(categorias);
        const colors = labels.map((_, index) => `hsl(${(index * 137.5) % 360}, 70%, 50%)`);

        // Criar novo gráfico
        despesasPieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('50%', '30%')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#a0a0a0',
                            font: {
                                family: 'Poppins',
                                size: 11
                            },
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e1e1e',
                        titleColor: '#fff',
                        bodyColor: '#a0a0a0',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = formatCurrencyValue(context.raw);
                                const percent = ((context.raw / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Erro ao carregar despesas para gráfico:', error);
    });
}

// Renderizar categorias
function renderCategorias(container, categorias, total, tipo) {
    // Ordenar categorias por valor
    const categoriasArray = Object.entries(categorias).map(([nome, dados]) => ({
        nome,
        ...dados
    })).sort((a, b) => b.total - a.total);

    // Mostrar apenas top 5 inicialmente
    const top5 = categoriasArray.slice(0, 5);
    const resto = categoriasArray.slice(5);

    container.innerHTML = '';

    if (categoriasArray.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Nenhuma ${tipo} cadastrada</p>`;
        return;
    }

    // Renderizar top 5
    top5.forEach(cat => renderCategoriaItem(container, cat, total));

    // Botão "Ver mais" se houver mais categorias
    if (resto.length > 0) {
        const btnVerMais = document.createElement('button');
        btnVerMais.className = 'ver-mais-btn';
        btnVerMais.textContent = `Ver mais ${resto.length} categoria${resto.length > 1 ? 's' : ''}`;
        btnVerMais.onclick = () => {
            resto.forEach(cat => renderCategoriaItem(container, cat, total));
            btnVerMais.remove();
        };
        container.appendChild(btnVerMais);
    }
}

// Renderizar item de categoria
function renderCategoriaItem(container, categoria, total) {
    const percent = total > 0 ? ((categoria.total / total) * 100).toFixed(1) : 0;
    
    // Pegar top 3 subcategorias
    const subcategoriasArray = Object.entries(categoria.subcategorias)
        .map(([nome, valor]) => ({ nome, valor }))
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 3);

    const item = document.createElement('div');
    item.className = 'categoria-item';
    
    item.innerHTML = `
        <div class="categoria-header">
            <div class="categoria-info">
                <span class="categoria-nome">${categoria.nome}</span>
                <div class="categoria-bar-container">
                    <div class="categoria-bar-fill" style="width: ${percent}%"></div>
                </div>
                <span class="categoria-valor">${formatCurrencyValue(categoria.total)}</span>
                <span class="categoria-percent">${percent}%</span>
            </div>
            <span class="categoria-expand-icon">▼</span>
        </div>
        <div class="subcategorias-list">
            ${subcategoriasArray.map(sub => `
                <div class="subcategoria-item">
                    <span class="subcategoria-nome">${sub.nome}</span>
                    <span class="subcategoria-valor">${formatCurrencyValue(sub.valor)}</span>
                </div>
            `).join('')}
        </div>
    `;

    // Toggle expansão
    const header = item.querySelector('.categoria-header');
    header.onclick = () => item.classList.toggle('expanded');

    container.appendChild(item);
}

// Atualizar gráfico de distribuição
function updateDistributionChart() {
    const canvas = document.getElementById('distribution-chart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    // Calcular totais
    let totalReceitas = 0;
    let totalDespesas = 0;

    document.querySelectorAll('#receitas-recorrentes-table tbody tr, #receitas-variaveis-table tbody tr').forEach(row => {
        const valorIndex = row.cells.length === 8 ? 3 : 3;
        totalReceitas += parseCurrency(row.cells[valorIndex].querySelector('input').value);
    });

    document.querySelectorAll('#despesas-fixas-table tbody tr, #despesas-variaveis-table tbody tr').forEach(row => {
        const valorIndex = 5;
        totalDespesas += parseCurrency(row.cells[valorIndex].querySelector('input').value);
    });

    // Destruir gráfico anterior
    if (dashboardChart) {
        dashboardChart.destroy();
    }

    // Criar novo gráfico
    dashboardChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Receitas', 'Despesas'],
            datasets: [{
                data: [totalReceitas, totalDespesas],
                backgroundColor: [
                    'rgba(255, 255, 255, 0.15)',
                    'rgba(255, 255, 255, 0.05)'
                ],
                borderColor: [
                    'rgba(255, 255, 255, 0.3)',
                    'rgba(255, 255, 255, 0.1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#a0a0a0',
                        font: {
                            family: 'Poppins',
                            size: 12
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: '#1e1e1e',
                    titleColor: '#fff',
                    bodyColor: '#a0a0a0',
                    borderColor: '#333',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            const value = formatCurrencyValue(context.raw);
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percent = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Atualizar situação financeira
function updateSituacaoFinanceira() {
    // Usar os mesmos valores dos cards superiores
    const saldoLiquido = parseCurrency(document.getElementById('dash-saldo-liquido')?.textContent || '0');
    const totalReceitas = parseCurrency(document.getElementById('dash-total-receitas')?.textContent || '0');
    const totalDespesas = parseCurrency(document.getElementById('dash-total-despesas')?.textContent || '0');

    document.getElementById('renda-media').textContent = formatCurrencyValue(totalReceitas);
    document.getElementById('despesa-media').textContent = formatCurrencyValue(totalDespesas);
    document.getElementById('saldo-atual').textContent = formatCurrencyValue(saldoLiquido);
}

// Atualizar objetivos financeiros
async function updateObjetivosFinanceiros() {
    const container = document.getElementById('objetivos-list');
    if (!container) return;

    try {
        const response = await fetch(`http://localhost:3000/profile/${userId}`);
        const profile = await response.json();
        const objetivos = profile.objetivos || {};

        container.innerHTML = '';

        // Fundo de emergência
        if (objetivos.fundoEmergencia) {
            const meta = parseCurrency(objetivos.fundoEmergencia);
            const saldoAtual = parseCurrency(document.getElementById('dash-saldo-liquido')?.textContent || '0');
            const progresso = meta > 0 ? Math.min((saldoAtual / meta) * 100, 100) : 0;

            container.innerHTML += `
                <div class="objetivo-item">
                    <div class="objetivo-header">
                        <span class="objetivo-nome">Fundo de Emergência</span>
                        <span class="objetivo-percent">${progresso.toFixed(0)}%</span>
                    </div>
                    <div class="objetivo-progress-bar">
                        <div class="objetivo-progress-fill" style="width: ${progresso}%"></div>
                    </div>
                    <div class="objetivo-valores">
                        <span>${formatCurrencyValue(saldoAtual)}</span>
                        <span>${formatCurrencyValue(meta)}</span>
                    </div>
                </div>
            `;
        }

        // Meta de longo prazo
        if (objetivos.metaLongoPrazo && objetivos.valorMetaLongo) {
            const meta = parseCurrency(objetivos.valorMetaLongo);
            const saldoAtual = parseCurrency(document.getElementById('dash-saldo-liquido')?.textContent || '0');
            const progresso = meta > 0 ? Math.min((saldoAtual / meta) * 100, 100) : 0;

            container.innerHTML += `
                <div class="objetivo-item">
                    <div class="objetivo-header">
                        <span class="objetivo-nome">${objetivos.metaLongoPrazo}</span>
                        <span class="objetivo-percent">${progresso.toFixed(0)}%</span>
                    </div>
                    <div class="objetivo-progress-bar">
                        <div class="objetivo-progress-fill" style="width: ${progresso}%"></div>
                    </div>
                    <div class="objetivo-valores">
                        <span>${formatCurrencyValue(saldoAtual)}</span>
                        <span>${formatCurrencyValue(meta)}</span>
                    </div>
                </div>
            `;
        }

        if (container.innerHTML === '') {
            container.innerHTML = '<div class="objetivo-empty">Nenhum objetivo financeiro cadastrado. Configure seus objetivos na página de perfil.</div>';
        }
    } catch (error) {
        console.error('Erro ao carregar objetivos:', error);
        container.innerHTML = '<div class="objetivo-empty">Erro ao carregar objetivos</div>';
    }
}

// Atualizar dívidas no dashboard
async function updateDividasDashboard() {
    const container = document.getElementById('dividas-dashboard-list');
    if (!container) return;

    try {
        const response = await fetch(`http://localhost:3000/dividas/${userId}`);
        const dividas = await response.json();

        container.innerHTML = '';

        if (!dividas || dividas.length === 0) {
            container.innerHTML = '<div class="dividas-empty">Nenhuma dívida ativa</div>';
            return;
        }

        dividas.forEach(divida => {
            const parcelasPagas = divida.parcelas.filter(p => p.pago).length;
            const totalParcelas = divida.parcelas.length;
            const percentualPago = totalParcelas > 0 ? Math.round((parcelasPagas / totalParcelas) * 100) : 0;

            container.innerHTML += `
                <div class="divida-dashboard-item">
                    <div class="divida-dashboard-info">
                        <div class="divida-dashboard-nome">${divida.nome}</div>
                        <div class="divida-dashboard-detalhes">
                            ${parcelasPagas}/${totalParcelas} parcelas pagas (${percentualPago}%)
                        </div>
                    </div>
                    <div class="divida-dashboard-valor">${divida.valorTotal}</div>
                </div>
            `;
        });
    } catch (error) {
        console.error('Erro ao carregar dívidas:', error);
        container.innerHTML = '<div class="dividas-empty">Erro ao carregar dívidas</div>';
    }
}

// Chamar ao trocar para o dashboard
function onDashboardShow() {
    updateFullDashboard();
    loadNotes();
}

// Adicionar listener para quando o dashboard for mostrado
document.addEventListener('DOMContentLoaded', () => {
    const dashboardBtn = document.querySelector('[onclick*="dashboard-content"]');
    if (dashboardBtn) {
        dashboardBtn.addEventListener('click', () => {
            setTimeout(onDashboardShow, 100);
        });
    }
    
    // Auto-save das anotações quando o usuário digita
    document.addEventListener('input', (e) => {
        if (e.target.classList.contains('notes-input')) {
            saveNotes();
        }
    });
});

// === SISTEMA DE ANOTAÇÕES ===

let currentNotesPage = 1;
let notesData = {}; // Estrutura: { userId: { pageNumber: [linha1, linha2, ...] } }

// Carregar anotações do servidor
async function loadNotes() {
    if (!userId) return;
    
    try {
        const response = await fetch(`http://localhost:3000/notes/${userId}`);
        const data = await response.json();
        notesData[userId] = data.notes || {};
        renderNotesPage(currentNotesPage);
    } catch (error) {
        console.error('Erro ao carregar anotações:', error);
        notesData[userId] = {};
    }
}

// Salvar anotações no servidor
async function saveNotes() {
    if (!userId) return;
    
    // Capturar dados da página atual
    const inputs = document.querySelectorAll('.notes-input');
    const pageData = [];
    inputs.forEach(input => {
        pageData.push(input.value);
    });
    
    // Atualizar estrutura de dados
    if (!notesData[userId]) {
        notesData[userId] = {};
    }
    notesData[userId][currentNotesPage] = pageData;
    
    // Salvar no servidor
    try {
        await fetch('http://localhost:3000/save-notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                userId, 
                notes: notesData[userId] 
            })
        });
    } catch (error) {
        console.error('Erro ao salvar anotações:', error);
    }
}

// Renderizar página de anotações
function renderNotesPage(pageNumber) {
    const container = document.getElementById('notes-page-container');
    const pageNumberDisplay = document.getElementById('current-page-number');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    // Atualizar número da página
    pageNumberDisplay.textContent = pageNumber;
    currentNotesPage = pageNumber;
    
    // Obter dados da página
    const pageData = (notesData[userId] && notesData[userId][pageNumber]) || ['', '', '', '', ''];
    
    // Renderizar linhas
    container.innerHTML = '';
    for (let i = 0; i < 5; i++) {
        const line = document.createElement('div');
        line.className = 'notes-line';
        line.innerHTML = `<input type="text" class="notes-input" data-page="${pageNumber}" data-line="${i + 1}" value="${pageData[i] || ''}" placeholder="">`;
        container.appendChild(line);
    }
    
    // Controlar visibilidade dos botões
    if (pageNumber === 1) {
        prevBtn.style.visibility = 'hidden';
    } else {
        prevBtn.style.visibility = 'visible';
    }
    
    // Verificar se há próxima página com conteúdo
    const hasNextPage = notesData[userId] && notesData[userId][pageNumber + 1] && 
                        notesData[userId][pageNumber + 1].some(line => line && line.trim() !== '');
    
    // Sempre mostrar botão próxima página
    nextBtn.style.visibility = 'visible';
}

// Próxima página
function nextNotesPage() {
    saveNotes(); // Salvar antes de trocar
    renderNotesPage(currentNotesPage + 1);
}

// Página anterior
function previousNotesPage() {
    if (currentNotesPage > 1) {
        saveNotes(); // Salvar antes de trocar
        renderNotesPage(currentNotesPage - 1);
    }
}

// Atualizar gráfico de rosca de subcategorias de receitas
function updateSubcategoriasReceitasChart() {
    const canvas = document.getElementById('subcategorias-receitas-chart');
    if (!canvas || !window.userId) return;

    const ctx = canvas.getContext('2d');

    // Buscar transações do mês atual
    fetch(`http://localhost:3000/transactions/${window.userId}`)
    .then(response => response.json())
    .then(allTransactions => {
        // Filtrar transações do mês atual e receitas
        const monthReceitas = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && 
                   transDate.getFullYear() === window.currentMonth.getFullYear() &&
                   trans.type === 'receitas';
        });

        // Coletar dados das subcategorias
        const subcategorias = {};
        let total = 0;

        monthReceitas.forEach(trans => {
            const subcategoria = trans.subcategoria || 'Sem subcategoria';
            const valor = parseCurrency(trans.valor);
            
            if (valor > 0 && subcategoria !== 'Selecione uma subcategoria' && subcategoria !== '') {
                subcategorias[subcategoria] = (subcategorias[subcategoria] || 0) + valor;
                total += valor;
            }
        });

        // Destruir gráfico anterior
        if (subcategoriasReceitasChart) {
            subcategoriasReceitasChart.destroy();
        }

        // Preparar dados
        const labels = Object.keys(subcategorias);
        const data = Object.values(subcategorias);
        const colors = labels.map((_, index) => `hsl(${(index * 137.5) % 360}, 70%, 50%)`);

        // Criar novo gráfico
        subcategoriasReceitasChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('50%', '30%')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#a0a0a0',
                            font: {
                                family: 'Poppins',
                                size: 11
                            },
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e1e1e',
                        titleColor: '#fff',
                        bodyColor: '#a0a0a0',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = formatCurrencyValue(context.raw);
                                const percent = ((context.raw / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Erro ao carregar subcategorias de receitas para gráfico:', error);
    });
}

// Atualizar gráfico de rosca de subcategorias de despesas
function updateSubcategoriasDespesasChart() {
    const canvas = document.getElementById('subcategorias-despesas-chart');
    if (!canvas || !window.userId) return;

    const ctx = canvas.getContext('2d');

    // Buscar transações do mês atual
    fetch(`http://localhost:3000/transactions/${window.userId}`)
    .then(response => response.json())
    .then(allTransactions => {
        // Filtrar transações do mês atual e despesas
        const monthDespesas = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && 
                   transDate.getFullYear() === window.currentMonth.getFullYear() &&
                   trans.type === 'despesas';
        });

        // Coletar dados das subcategorias
        const subcategorias = {};
        let total = 0;

        monthDespesas.forEach(trans => {
            const subcategoria = trans.subcategoria || 'Sem subcategoria';
            const valor = parseCurrency(trans.valor);
            
            if (valor > 0 && subcategoria !== 'Selecione uma subcategoria' && subcategoria !== '') {
                subcategorias[subcategoria] = (subcategorias[subcategoria] || 0) + valor;
                total += valor;
            }
        });

        // Destruir gráfico anterior
        if (subcategoriasDespesasChart) {
            subcategoriasDespesasChart.destroy();
        }

        // Preparar dados
        const labels = Object.keys(subcategorias);
        const data = Object.values(subcategorias);
        const colors = labels.map((_, index) => `hsl(${(index * 137.5) % 360}, 70%, 50%)`);

        // Criar novo gráfico
        subcategoriasDespesasChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('50%', '30%')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#a0a0a0',
                            font: {
                                family: 'Poppins',
                                size: 11
                            },
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e1e1e',
                        titleColor: '#fff',
                        bodyColor: '#a0a0a0',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = formatCurrencyValue(context.raw);
                                const percent = ((context.raw / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Erro ao carregar subcategorias de despesas para gráfico:', error);
    });
}

app.js:
let categoriesReceitas = new Set();
let categoriesDespesas = new Set();
let chatStarted = false;

window.userId = null; // Será definido após login

const categoryColors = [
    '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
    '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA',
    '#F1948A', '#85C1E9', '#D7BDE2', '#AED6F1', '#A3E4D7'
];

let categoryColorMap = new Map();

// Função para obter cor baseada no nome da categoria
function getCategoryColor(category) {
    if (categoryColorMap.has(category)) {
        return categoryColorMap.get(category);
    } else {
        const hash = category.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
        const color = categoryColors[hash % categoryColors.length];
        categoryColorMap.set(category, color);
        return color;
    }
}

const subcategoriesMap = {
    receitas: {
        'Salário e Rendimentos do Trabalho': [
            'Salário fixo', 'Horas extras', 'Bônus e comissões', 'Férias recebidas', 'Participação nos lucros',
            'Vale-refeição', 'Trabalho autônomo', 'Freelance', 'Diárias e gratificações'
        ],
        'Renda de Empreendimentos': [
            'Lucro de empresa própria', 'Distribuição de lucros', 'Venda de produtos', 'Prestação de serviços'
        ],
        'Renda de Aluguéis': [
            'Aluguel de imóvel residencial', 'Aluguel de imóvel comercial', 'Aluguel por temporada (Airbnb)'
        ],
        'Investimentos': [
            'Dividendos de ações', 'Juros sobre capital próprio', 'Rendimentos de fundos imobiliários',
            'Ganhos com venda de ações', 'Renda de CDBs e RDBs', 'Renda de Tesouro Direto',
            'Renda de criptomoedas', 'Renda de ETFs', 'Renda de debêntures', 'Renda de previdência privada'
        ],
        'Juros e Rendimentos Financeiros': [
            'Juros de poupança', 'Juros de aplicações bancárias', 'Juros de empréstimos concedidos',
            'Juros de títulos públicos', 'Juros de contas remuneradas', 'Juros de consórcios'
        ],
        'Presentes, Doações e Heranças': [
            'Presentes em dinheiro', 'Doações familiares', 'Herança recebida', 'Transferência de bens',
            'Doações de amigos', 'Presentes de casamento', 'Presentes de aniversário', 'Prêmios em sorteios'
        ],
        'Venda de Bens e Ativos': [
            'Venda de carro', 'Venda de imóvel', 'Venda de eletrônicos', 'Venda de móveis',
            'Venda de roupas', 'Venda de joias', 'Venda de obras de arte', 'Venda de instrumentos musicais',
            'Venda de equipamentos', 'Venda de itens colecionáveis'
        ]
    },
    despesas: {
        'Moradia': [
            'Aluguel', 'Financiamento imobiliário', 'Condomínio', 'Energia elétrica', 'Água e esgoto',
            'Gás encanado ou botijão', 'Internet residencial', 'Manutenção e reparos', 'Móveis e decoração',
            'Produtos de limpeza'
        ],
        'Transporte': [
            'Combustível', 'Manutenção do veículo', 'Seguro do carro', 'IPVA e licenciamento',
            'Estacionamento', 'Transporte público', 'Aplicativos de transporte (Uber, 99)', 'Pedágios',
            'Lavagem e estética automotiva', 'Financiamento de veículo'
        ],
        'Alimentação': [
            'Supermercado', 'Restaurantes', 'Delivery', 'Lanches e cafés', 'Refeições no trabalho',
            'Bebidas alcoólicas', 'Suplementos alimentares'
        ],
        'Saúde': [
            'Plano de saúde', 'Medicamentos', 'Consultas médicas', 'Exames laboratoriais',
            'Terapias (fisioterapia, psicologia)', 'Odontologia', 'Óculos e lentes', 'Academia e atividades físicas'
        ],
        'Educação': [
            'Mensalidade escolar/universitária', 'Cursos de idiomas', 'Cursos profissionalizantes',
            'Material escolar', 'Livros e e-books', 'Plataformas de ensino online', 'Transporte escolar',
            'Uniformes', 'Aulas particulares', 'Inscrição em provas e concursos'
        ],
        'Lazer e Entretenimento': [
            'Cinema e teatro', 'Assinaturas de streaming', 'Viagens e turismo', 'Passeios e eventos',
            'Hobbies (instrumentos, artesanato)', 'Jogos e videogames', 'Parques e atrações',
            'Festas e comemorações', 'Clube ou associação recreativa', 'Livros de entretenimento'
        ],
        'Vestuário e Cuidados Pessoais': [
            'Roupas', 'Calçados', 'Acessórios (bolsas, cintos)', 'Salão de beleza', 'Barbearia',
            'Cosméticos', 'Perfumes', 'Cuidados com a pele'
        ],
        'Seguros e Proteção': [
            'Seguro de vida', 'Seguro residencial', 'Seguro automotivo', 'Seguro viagem',
            'Seguro saúde complementar', 'Seguro de equipamentos eletrônicos', 'Seguro de acidentes pessoais',
            'Seguro para pets', 'Assistência 24h', 'Planos de proteção digital'
        ],
        'Serviços Financeiros': [
            'Tarifas bancárias', 'Anuidade de cartão de crédito', 'Consultoria financeira', 'Contabilidade',
            'Investimentos (ações, fundos)', 'Previdência privada', 'Taxas de corretagem', 'Juros e encargos',
            'Empréstimos e financiamentos', 'Aplicativos de controle financeiro'
        ],
        'Tecnologia e Comunicação': [
            'Celular (aparelho)', 'Plano de celular', 'Internet residencial', 'Assinaturas de apps',
            'Softwares e licenças', 'Equipamentos eletrônicos', 'Manutenção de eletrônicos',
            'Acessórios (fones, cabos)', 'Serviços de nuvem'
        ],
        'Filhos e Dependentes': [
            'Creche', 'Escola', 'Roupas infantis', 'Brinquedos', 'Fraldas e higiene',
            'Alimentação infantil', 'Atividades extracurriculares', 'Mesada', 'Transporte escolar'
        ],
        'Impostos e Obrigações Legais': [
            'Imposto de Renda', 'IPVA', 'IPTU', 'Taxas municipais', 'Contribuições sindicais',
            'Multas de trânsito', 'Taxas de cartório', 'Custas judiciais', 'Contribuições previdenciárias',
            'Parcelamentos de débitos'
        ],
        'Serviços Domésticos': [
            'Faxina', 'Lavanderia', 'Jardinagem', 'Piscineiro', 'Diarista', 'Babá',
            'Cuidador de idosos', 'Reparos elétricos', 'Reparos hidráulicos', 'Instalações e montagens'
        ],
        'Compras e Consumo': [
            'Eletrodomésticos', 'Eletrônicos', 'Móveis', 'Utensílios domésticos', 'Artigos de papelaria',
            'Itens de decoração', 'Ferramentas', 'Produtos de pet shop', 'Compras online', 'Produtos sazonais (Natal, Páscoa)'
        ],
        'Outros': [
            'Presentes', 'Doações', 'Gorjetas', 'Multas e penalidades', 'Compras por impulso',
            'Gastos com animais de estimação', 'Despesas judiciais', 'Taxas de cartório'
        ]
    }
};

// Atualizar createCategorySelect para usar as categorias principais
function createCategorySelect(type) {
    const select = document.createElement('select');
    select.className = 'category-select';
    select.style.width = '100%';
    select.style.padding = 'var(--spacing-xs)';
    select.style.border = '1px solid var(--color-border)';
    select.style.borderRadius = 'var(--radius-sm)';
    select.style.background = 'var(--color-background)';
    select.style.color = 'var(--color-text-primary)';

    // Adicionar opção vazia
    const emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.textContent = 'Selecione uma categoria';
    select.appendChild(emptyOpt);

    // Adicionar categorias principais
    Object.keys(subcategoriesMap[type]).forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
    });

    return select;
}

async function processWithAI(description, tableType) {
    console.log('🔵 [processWithAI] Iniciando processamento');
    console.log('📝 Descrição:', description);
    console.log('📊 Tipo de tabela:', tableType);
    
    const type = tableType.startsWith('receitas') ? 'receitas' : 'despesas';
    const categories = Object.keys(subcategoriesMap[type]);
    console.log('📁 Tipo:', type);
    console.log('🗂️ Categorias disponíveis:', categories);

    try {
        // Etapa 1: Identificar todas as categorias
        console.log('🔄 Etapa 1: Identificando categoria...');
        const categoryResponse = await fetch('http://localhost:3000/process-category', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description, categories, userId: window.userId })
        });
        const categoryData = await categoryResponse.json();
        const category = categoryData.category;
        console.log('✅ Categoria identificada:', category);

        // Etapa 2: Processar múltiplas transações
        const subcategories = subcategoriesMap[type][category] || [];
        const isReceita = type === 'receitas';
        console.log('🔄 Etapa 2: Processando subcategorias...');
        console.log('🏷️ Subcategorias disponíveis:', subcategories);
        console.log('💰 É receita?', isReceita);
        
        const subcategoryResponse = await fetch('http://localhost:3000/process-subcategory', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description, category, subcategories, userId: window.userId, isReceita })
        });
        const result = await subcategoryResponse.json();
        console.log('📦 Resposta da IA (raw):', result);

        // Retornar array (pode ter 1 ou mais transações)
        const finalResult = Array.isArray(result) ? result : [result];
        console.log('✅ Resultado final (array):', finalResult);
        return finalResult;
    } catch (error) {
        console.error('❌ [processWithAI] Erro:', error);
        throw error;
    }
}

// Função para abrir modal de IA
function openModal() {
    const modal = document.getElementById('ai-modal');
    if (!modal) return;

    modal.style.display = 'block';

    // Resetar estados e textos para passo 1
    const modalTitle = document.getElementById('modal-title');
    const modalDesc = document.getElementById('modal-desc');
    modalTitle.textContent = 'Selecione a Planilha';
    modalDesc.textContent = 'Escolha em qual tabela você deseja adicionar a transação para que a IA possa processar corretamente.';
    const tableSelect = document.getElementById('table-select');
    const inputSection = document.getElementById('input-section');
    tableSelect.style.display = 'block';
    tableSelect.style.opacity = '1';
    inputSection.style.display = 'none';
    inputSection.style.opacity = '0';
    tableSelect.value = '';
    document.getElementById('ai-description').value = '';
    document.getElementById('ai-loading').style.display = 'none';

    // Event listener para o select
    tableSelect.addEventListener('change', () => {
        const selected = tableSelect.value;
        if (selected) {
            // Mudar textos para passo 2
            modalTitle.textContent = 'Descreva a Transação';
            modalDesc.textContent = 'Digite uma descrição simples (ex.: "Recebi R$ 5000 de salário hoje"). A IA vai preencher automaticamente.';
            // Fade out do select
            tableSelect.style.opacity = '0';
            setTimeout(() => {
                tableSelect.style.display = 'none';
                // Fade in do input
                inputSection.style.display = 'block';
                setTimeout(() => {
                    inputSection.style.opacity = '1';
                    document.getElementById('ai-description').focus();
                }, 10);
            }, 300);
        }
    });

    // Função para formatar valor como moeda
function formatCurrencyValue(value) {
    const num = parseFloat(value);
    if (isNaN(num)) return '';
    return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

    // Event listeners para botões
    document.getElementById('close-modal').onclick = () => {
        modal.style.display = 'none';
    };
    document.getElementById('ai-submit').onclick = async () => {
    const tableType = tableSelect.value;
    const description = document.getElementById('ai-description').value.trim();
    console.log('🚀 [ai-submit] Botão clicado');
    console.log('📊 Tabela selecionada:', tableType);
    console.log('📝 Descrição:', description);
    
    if (!tableType || !description) return alert('Selecione a tabela e digite uma descrição.');

    document.getElementById('ai-loading').style.display = 'block';
    try {
        console.log('⏳ Processando com IA...');
        const results = await processWithAI(description, tableType); // Agora retorna array
        console.log('✅ Resultados recebidos:', results);
        
        // Iterar sobre cada transação e criar linha
        console.log(`📝 Criando ${results.length} linha(s)...`);
        results.forEach((result, index) => {
            console.log(`📄 Preenchendo linha ${index + 1}:`, result);
            fillRowWithAI(null, tableType, result);
        });
        
        console.log('✅ Todas as linhas criadas com sucesso!');
        modal.style.display = 'none';
    } catch (error) {
        console.error('❌ [ai-submit] Erro completo:', error);
        alert('Erro ao processar com IA. Tente novamente.');
    } finally {
        document.getElementById('ai-loading').style.display = 'none';
    }
};
}


// Função para preencher linha com dados da IA
function fillRowWithAI(row, tableType, data) {
    console.log('🖊️ [fillRowWithAI] Iniciando preenchimento');
    console.log('📊 Tabela:', tableType);
    console.log('📦 Dados recebidos:', data);
    
    // Encontrar linha vazia ou usar a fornecida
    let targetRow = row; // row passada como parâmetro (se aplicável)
    if (!targetRow) {
        const tbody = document.getElementById(`${tableType}-table`).querySelector('tbody');
        const isReceita = tableType.startsWith('receitas');
        console.log('🔍 Procurando linha vazia...');
        
        // Procurar linha vazia usando critérios específicos:
        // 1. Descrição vazia (coluna 2)
        // 2. Categoria com valor "Selecione uma categoria" (coluna 4 para receitas, coluna 3 para despesas)
        for (let i = 0; i < tbody.rows.length; i++) {
            const r = tbody.rows[i];
            const descricaoInput = r.cells[2].querySelector('input');
            const categoriaSelect = isReceita ? r.cells[4].querySelector('select') : r.cells[3].querySelector('select');
            
            const descricaoVazia = descricaoInput && descricaoInput.value.trim() === '';
            const categoriaPadrao = categoriaSelect && categoriaSelect.value === 'Selecione uma categoria';
            
            console.log(`📋 Linha ${i}: Descrição vazia? ${descricaoVazia}, Categoria padrão? ${categoriaPadrao}`);
            
            if (descricaoVazia && categoriaPadrao) {
                targetRow = r;
                console.log(`✅ Linha vazia encontrada no índice ${i}`);
                break;
            }
        }
        // Se não encontrou linha vazia, adicionar nova
        if (!targetRow) {
            console.log('➕ Nenhuma linha vazia, adicionando nova...');
            addRow(tableType);
            targetRow = tbody.rows[tbody.rows.length - 1];
        }
    }

    const cells = targetRow.cells;
    const isReceita = tableType.startsWith('receitas');
    console.log('💰 É receita?', isReceita);
    console.log('📋 Total de células:', cells.length);
    
    try {
        // Preencher data e criar timestamp
        console.log('📅 Preenchendo data:', data.data);
        const dateInput = cells[0].querySelector('input');
        dateInput.value = data.data;
        
        // Criar timestamp com hora, minuto e segundo atuais
        const [year, month, day] = data.data.split('-');
        const now = new Date();
        const timestamp = new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds()).toISOString();
        dateInput.setAttribute('data-timestamp', timestamp);
        console.log('⏰ Timestamp criado:', timestamp);
        
        // Preencher status (coluna 1)
        console.log('🔖 Preenchendo status:', data.status || '(vazio)');
        console.log('🔍 Status select encontrado:', cells[1].querySelector('select') !== null);
        const statusSelect = cells[1].querySelector('select');
        if (data.status) {
            console.log('✅ Setando status para:', data.status);
            statusSelect.value = data.status;
            console.log('✅ Status setado. Valor atual:', statusSelect.value);
        } else {
            console.log('⚠️ Nenhum status fornecido pela IA');
        }
        
        // Preencher descrição (coluna 2)
        console.log('📝 Preenchendo descrição:', data.descricao);
        cells[2].querySelector('input').value = data.descricao;
        
        // Preencher valor (coluna 3 para receitas, coluna 5 para despesas)
        const valorCell = isReceita ? cells[3] : cells[5];
        console.log(`💵 Preenchendo valor na coluna ${isReceita ? 3 : 5}:`, data.valor);
        valorCell.querySelector('input').value = formatCurrencyValue(data.valor);
        
        // Preencher categoria
        const catSelect = isReceita ? cells[4].querySelector('select') : cells[3].querySelector('select');
        console.log(`🗂️ Preenchendo categoria na coluna ${isReceita ? 4 : 3}:`, data.category);
        catSelect.value = data.category;
        
        // Preencher subcategoria
        const subSelect = isReceita ? cells[5].querySelector('select') : cells[4].querySelector('select');
        console.log(`🏷️ Preenchendo subcategoria na coluna ${isReceita ? 5 : 4}:`, data.subcategory);
        subSelect.innerHTML = '';
        const subs = subcategoriesMap[isReceita ? 'receitas' : 'despesas'][data.category] || [];
        console.log('🏷️ Subcategorias disponíveis:', subs);
        subs.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            subSelect.appendChild(opt);
        });
        subSelect.value = data.subcategory;
        
        // Preencher notas (coluna 6 para receitas, coluna 7 para despesas)
        const notasCell = isReceita ? cells[6] : cells[7];
        console.log(`📋 Preenchendo notas na coluna ${isReceita ? 6 : 7}:`, data.notas || '(vazio)');
        if (notasCell && notasCell.querySelector('input')) {
            notasCell.querySelector('input').value = data.notas || '';
        }
        
        // Para despesas, preencher método de pagamento (coluna 6)
        if (!isReceita && data.metodo) {
            const metodoCell = cells[6];
            console.log('💳 Preenchendo método na coluna 6:', data.metodo);
            if (metodoCell && metodoCell.querySelector('select')) {
                metodoCell.querySelector('select').value = data.metodo;
            }
        }
        
        console.log('✅ Preenchimento concluído com sucesso!');
        
        // Salvar transação
        console.log('💾 Salvando transação...');
        saveTransaction(tableType, targetRow);
        updateDashboard();
        console.log('✅ Transação salva e dashboard atualizado!');
    } catch (error) {
        console.error('❌ [fillRowWithAI] Erro durante preenchimento:', error);
        console.error('Stack trace:', error.stack);
        throw error;
    }
}

// Nova função para criar select de subcategoria
function createSubcategorySelect(category, type) {
    const select = document.createElement('select');
    select.className = 'subcategory-select';
    select.style.width = '100%';
    select.style.padding = 'var(--spacing-xs)';
    select.style.border = '1px solid var(--color-border)';
    select.style.borderRadius = 'var(--radius-sm)';
    select.style.background = 'var(--color-background)';
    select.style.color = 'var(--color-text-primary)';

    // Adicionar opção vazia
    const emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.textContent = 'Selecione uma subcategoria';
    select.appendChild(emptyOpt);

    // Adicionar subcategorias se categoria estiver definida
    if (category && subcategoriesMap[type][category]) {
        subcategoriesMap[type][category].forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            select.appendChild(opt);
        });
    }

    return select;
}

// Função para coletar categorias de receitas
function collectCategoriesReceitas() {
    categoriesReceitas.clear();
    const receitaTags = document.querySelectorAll('#receitas-table .category-tag');
    receitaTags.forEach(tag => {
        if (tag.style.display !== 'none' && tag.textContent.trim()) {
            categoriesReceitas.add(tag.textContent.trim());
        }
    });
}

// Função para coletar categorias de despesas
function collectCategoriesDespesas() {
    categoriesDespesas.clear();
    const despesaTags = document.querySelectorAll('#despesas-table .category-tag');
    despesaTags.forEach(tag => {
        if (tag.style.display !== 'none' && tag.textContent.trim()) {
            categoriesDespesas.add(tag.textContent.trim());
        }
    });
}



// Função para atualizar dropdown com categorias do tipo
function updateDropdown(dropdown, type) {
    dropdown.innerHTML = '';
    const cats = type === 'receitas' ? categoriesReceitas : categoriesDespesas;
    cats.forEach(cat => {
        const li = document.createElement('li');
        li.textContent = cat;
        dropdown.appendChild(li);
    });
}

// Função para desformatar moeda (R$ 1.000,00 -> 1000.00)
function parseCurrency(str) {
    if (!str) return 0;
    return parseFloat(str.replace(/[^\d,]/g, '').replace(',', '.'));
}

document.addEventListener('DOMContentLoaded', () => {
    // Verificar se o usuário está logado
    window.userId = sessionStorage.getItem('userId');
    if (!window.userId) {
        showLoginModal();
        return; // Não continuar carregando a página até login
    }

    // Continuar com o código existente se logado
    const input = document.getElementById('message-input');
    const prompt = document.querySelector('.finance-prompt');

    // Mostrar prompt inicialmente
    prompt.style.display = 'block';

    // Esconder/mostrar prompt ao digitar, apenas se o chat não foi iniciado
    input.addEventListener('input', () => {
        if (!chatStarted) {
            if (input.value.trim() !== '') {
                prompt.style.display = 'none';
            } else {
                prompt.style.display = 'block';
            }
        }
    });

    // Filtros de tabela
    document.querySelectorAll('.filter-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            const tableId = icon.dataset.table;
            const columnId = icon.dataset.column;
            const select = document.querySelector(`.filter-select[data-table="${tableId}"][data-column="${columnId}"]`);
            select.style.display = select.style.display === 'none' ? 'inline-block' : 'none';
        });
    });

    document.querySelectorAll('.filter-select').forEach(select => {
        select.addEventListener('change', () => {
            const tableId = select.dataset.table;
            const criteria = select.value;
            sortTable(tableId, criteria);
            select.style.display = 'none'; // Esconder após seleção
        });
    });

    // Aplicar filtro padrão (Mais Recente) ao carregar
    const tables = ['receitas-recorrentes-table', 'receitas-variaveis-table', 'despesas-fixas-table', 'despesas-variaveis-table'];
    tables.forEach(tableId => {
        sortTable(tableId, 'date-desc');
    });
});

// Função para mostrar modal de login/cadastro
function showLoginModal() {
    const modal = document.getElementById('login-modal');
    modal.style.display = 'flex'; // Mostrar o modal

    // Estado inicial: login
    let isRegisterMode = false;

    // Evento para login
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isRegisterMode) {
            // Modo cadastro: coletar todos os campos
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nome = document.getElementById('modal-nome').value;
            const nascimento = document.getElementById('modal-nascimento').value;
            const contato = document.getElementById('modal-contato').value;
            await registerUser(email, password, { nome, nascimento, contato });
        } else {
            // Modo login
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            await loginUser(email, password);
        }
    });

    // Evento para alternar para modo cadastro
    document.getElementById('register-btn').addEventListener('click', () => {
        isRegisterMode = true;
        document.getElementById('modal-title').textContent = 'Cadastro Completo';
        document.getElementById('extra-fields').style.display = 'block';
        document.getElementById('submit-btn').textContent = 'Cadastrar';
        document.getElementById('register-btn').style.display = 'none';
        document.getElementById('login-btn').style.display = 'inline-block'; // Mostrar botão voltar
    });

    // Evento para voltar ao login
    document.getElementById('login-btn').addEventListener('click', () => {
        isRegisterMode = false;
        document.getElementById('modal-title').textContent = 'Login ou Cadastro';
        document.getElementById('extra-fields').style.display = 'none';
        document.getElementById('submit-btn').textContent = 'Entrar';
        document.getElementById('register-btn').style.display = 'inline-block';
        document.getElementById('login-btn').style.display = 'none'; // Ocultar botão voltar
    });
}

// Função para login
async function loginUser(email, password) {
    try {
        const response = await fetch('http://localhost:3000/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        if (response.ok) {
            window.userId = data.userId;
            sessionStorage.setItem('userId', window.userId); // Usar sessionStorage
            document.getElementById('login-modal').style.display = 'none'; // Ocultar modal
            location.reload(); // Recarregar para inicializar com userId
        } else {
            document.getElementById('message').textContent = data.message;
        }
    } catch (error) {
        document.getElementById('message').textContent = 'Erro ao fazer login';
    }
}

// Função para cadastro
async function registerUser(email, password, extraData) {
    try {
        const response = await fetch('http://localhost:3000/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, ...extraData })
        });
        const data = await response.json();
        if (response.ok) {
            window.userId = data.userId;
            sessionStorage.setItem('userId', window.userId); // Usar sessionStorage
            document.getElementById('login-modal').style.display = 'none'; // Ocultar modal
            location.reload(); // Recarregar para inicializar com userId
        } else {
            document.getElementById('message').textContent = data.message;
        }
    } catch (error) {
        document.getElementById('message').textContent = 'Erro ao cadastrar';
    }
}

function logout() {
    // Remover userId do sessionStorage para "sair"
    sessionStorage.removeItem('userId');
    window.userId = null;
    // Recarregar a página para mostrar o modal de login
    location.reload();
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed');
}

function showPage(pageId) {
    const pages = document.querySelectorAll('.page-section');
    pages.forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    if (pageId === 'minhas-financas') {
        initializeFinances();
    }
    if (pageId === 'financas') {
        updateCompactDashboard();
    }
    if (pageId === 'perfil') {
        loadProfile();
    }
}

function showSubPage(subPageId) {
    const subPages = document.querySelectorAll('.subpage');
    subPages.forEach(page => page.classList.remove('active'));
    document.getElementById(subPageId).classList.add('active');
    const btns = document.querySelectorAll('.subpage-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Atualizar dashboard quando a aba for mostrada
    if (subPageId === 'dashboard-content' && typeof updateFullDashboard === 'function') {
        setTimeout(() => updateFullDashboard(), 100);
    }
}

// Função para formatar moeda
function formatCurrency(input) {
    let value = input.value.replace(/[^\d]/g, ''); // Remove tudo exceto dígitos
    if (value) {
        value = parseFloat(value) / 100; // Assume entrada em centavos para facilitar
        input.value = value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    } else {
        input.value = '';
    }
}

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (message === '') return;

    addMessage(message, 'user');
    input.value = '';

    // Se é a primeira mensagem, marcar chat como iniciado e esconder prompt
    if (!chatStarted) {
        chatStarted = true;
        document.querySelector('.finance-prompt').style.display = 'none';
    }

    // Adicionar mensagem de pensando com ícone animado
    const thinkingMessage = addMessage('', 'bot');
    thinkingMessage.classList.add('thinking');
    thinkingMessage.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pensando...'; // Ícone girando

    fetch('http://localhost:3000/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, userId: window.userId })
    })
    .then(response => response.json())
    .then(data => {
        // Remover mensagem de pensando
        thinkingMessage.remove();
        // Adicionar resposta com efeito máquina de escrever
        addMessageTypewriter(data.reply, 'bot');
    })
    .catch(error => {
        thinkingMessage.remove();
        addMessage('Erro ao processar mensagem.', 'bot');
        console.error('Erro ao enviar mensagem:', error);
    });
}

function addMessage(text, sender) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.textContent = text;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    return messageDiv; // Retorne para poder remover depois
}

function addMessageTypewriter(text, sender) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messagesDiv.appendChild(messageDiv);

    const words = text.split(' ');
    let currentIndex = 0;
    let charIndex = 0;
    let currentWord = '';

    const interval = setInterval(() => {
        if (currentIndex < 5) {
            // Primeiras 5 palavras: letra por letra
            if (charIndex < words[currentIndex].length) {
                currentWord += words[currentIndex][charIndex];
                messageDiv.textContent = words.slice(0, currentIndex).join(' ') + (currentIndex > 0 ? ' ' : '') + currentWord;
                charIndex++;
            } else {
                messageDiv.textContent = words.slice(0, currentIndex + 1).join(' ');
                currentIndex++;
                charIndex = 0;
                currentWord = '';
            }
        } else {
            // A partir da 5ª palavra: palavra por palavra, velocidade dobrada
            if (currentIndex < words.length) {
                messageDiv.textContent = words.slice(0, currentIndex + 1).join(' ');
                currentIndex++;
            } else {
                clearInterval(interval);
                // Renderizar Markdown completo ao final
                messageDiv.innerHTML = marked.parse(text);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
    }, currentIndex < 5 ? 50 : 25);
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

finance.js
let exampleDataAdded = false;

window.currentMonth = new Date();

function sortTable(tableId, criteria) {
    // Adicionar sufixo '-table' se não estiver presente
    const fullTableId = tableId.endsWith('-table') ? tableId : `${tableId}-table`;
    const tbody = document.querySelector(`#${fullTableId} tbody`);
    if (!tbody) return;
    const rows = Array.from(tbody.rows);

    // Determinar índices baseados na tabela
    const isDespesa = fullTableId.includes('despesas');
    const dateIndex = 0;
    const valueIndex = isDespesa ? 5 : 3; // Despesas: valor na coluna 5; Receitas: coluna 3

    rows.sort((a, b) => {
        let aVal, bVal;
        if (criteria.startsWith('date')) {
            // Usar timestamp completo se disponível, senão usar apenas a data
            const aInput = a.cells[dateIndex].querySelector('input');
            const bInput = b.cells[dateIndex].querySelector('input');
            const aTimestamp = aInput.getAttribute('data-timestamp');
            const bTimestamp = bInput.getAttribute('data-timestamp');
            
            if (aTimestamp && bTimestamp) {
                aVal = new Date(aTimestamp);
                bVal = new Date(bTimestamp);
            } else {
                aVal = new Date(aInput.value || '1970-01-01');
                bVal = new Date(bInput.value || '1970-01-01');
            }
        } else if (criteria.startsWith('value')) {
            aVal = parseCurrency(a.cells[valueIndex].querySelector('input').value);
            bVal = parseCurrency(b.cells[valueIndex].querySelector('input').value);
        }

        if (criteria.endsWith('-desc')) {
            return bVal - aVal;
        } else {
            return aVal - bVal;
        }
    });

    rows.forEach(row => tbody.appendChild(row));
}

// Função para atualizar display do mês
function updateMonthDisplay() {
    const options = { year: 'numeric', month: 'long' };
    document.getElementById('current-month-display').textContent = window.currentMonth.toLocaleDateString('pt-BR', options);
}

// Função para mês anterior
function previousMonth() {
    window.currentMonth.setMonth(window.currentMonth.getMonth() - 1);
    updateMonthDisplay();
    loadTransactionsForMonth();
    if (typeof updateFullDashboard === 'function') {
        updateFullDashboard();
    }
}

// Função para mês próximo
function nextMonth() {
    window.currentMonth.setMonth(window.currentMonth.getMonth() + 1);
    updateMonthDisplay();
    loadTransactionsForMonth();
    if (typeof updateFullDashboard === 'function') {
        updateFullDashboard();
    }
}

async function loadTransactionsForMonth() {
    try {
        const response = await fetch(`http://localhost:3000/transactions/${userId}`);
        const allTransactions = await response.json();

        // Filtrar transações do mês atual
        const monthTransactions = allTransactions.filter(trans => {
            const transDate = new Date(trans.data);
            return transDate.getMonth() === window.currentMonth.getMonth() && transDate.getFullYear() === window.currentMonth.getFullYear();
        });

        // Limpar tabelas
        ['receitas-recorrentes', 'receitas-variaveis', 'despesas-fixas', 'despesas-variaveis'].forEach(tableType => {
            const tbody = document.getElementById(`${tableType}-table`).querySelector('tbody');
            tbody.innerHTML = '';
        });

        // Adicionar transações filtradas
        monthTransactions.forEach(trans => {
            const tableType = trans.type === 'receitas' ? (trans.subType === 'recorrente' ? 'receitas-recorrentes' : 'receitas-variaveis') : (trans.subType === 'fixa' ? 'despesas-fixas' : 'despesas-variaveis');
            const table = document.getElementById(`${tableType}-table`).querySelector('tbody');
            const row = table.insertRow();

            if (tableType === 'receitas-recorrentes') {
                row.innerHTML = `
                    <td><input type="date" value="${trans.data.split('T')[0]}"></td>
                    <td><select>
                        <option value="">Selecione</option>
                        <option value="Recebido" ${trans.status === 'Recebido' ? 'selected' : ''}>Recebido</option>
                        <option value="Pendente" ${trans.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="Atrasado" ${trans.status === 'Atrasado' ? 'selected' : ''}>Atrasado</option>
                    </select></td>
                    <td><input type="text" value="${trans.fonteOuDescricao}"></td>
                    <td><input type="text" value="${trans.valor}" oninput="formatCurrency(this); updateDashboard();"></td>
                    <td></td>
                    <td></td>
                    <td><input type="text" value="${trans.notas}"></td>
                    <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
                `;
                // Adicionar timestamp ao input de data
                if (trans.timestamp) {
                    row.cells[0].querySelector('input').setAttribute('data-timestamp', trans.timestamp);
                }
                
                const categoryCell = row.cells[4];
                const categorySelect = createCategorySelect('receitas');
                categorySelect.value = trans.categoria || '';
                categoryCell.appendChild(categorySelect);
                const subcategoryCell = row.cells[5];
                const subcategorySelect = createSubcategorySelect(trans.categoria, 'receitas');
                subcategorySelect.value = trans.subcategoria || '';
                subcategoryCell.appendChild(subcategorySelect);
                categorySelect.addEventListener('change', () => {
                    subcategorySelect.innerHTML = '';
                    const subs = subcategoriesMap.receitas[categorySelect.value] || [];
                    subs.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub;
                        opt.textContent = sub;
                        subcategorySelect.appendChild(opt);
                    });
                });
            } else if (tableType === 'receitas-variaveis') {
                row.innerHTML = `
                    <td><input type="date" value="${trans.data.split('T')[0]}"></td>
                    <td><select>
                        <option value="">Selecione</option>
                        <option value="Recebido" ${trans.status === 'Recebido' ? 'selected' : ''}>Recebido</option>
                        <option value="Pendente" ${trans.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="Atrasado" ${trans.status === 'Atrasado' ? 'selected' : ''}>Atrasado</option>
                    </select></td>
                    <td><input type="text" value="${trans.fonteOuDescricao}"></td>
                    <td><input type="text" value="${trans.valor}" oninput="formatCurrency(this); updateDashboard();"></td>
                    <td></td>
                    <td></td>
                    <td><input type="text" value="${trans.notas}"></td>
                    <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
                `;
                // Adicionar timestamp ao input de data
                if (trans.timestamp) {
                    row.cells[0].querySelector('input').setAttribute('data-timestamp', trans.timestamp);
                }
                
                const categoryCell = row.cells[4];
                const categorySelect = createCategorySelect('receitas');
                categorySelect.value = trans.categoria || '';
                categoryCell.appendChild(categorySelect);
                const subcategoryCell = row.cells[5];
                const subcategorySelect = createSubcategorySelect(trans.categoria, 'receitas');
                subcategorySelect.value = trans.subcategoria || '';
                subcategoryCell.appendChild(subcategorySelect);
                categorySelect.addEventListener('change', () => {
                    subcategorySelect.innerHTML = '';
                    const subs = subcategoriesMap.receitas[categorySelect.value] || [];
                    subs.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub;
                        opt.textContent = sub;
                        subcategorySelect.appendChild(opt);
                    });
                });
            } else if (tableType === 'despesas-fixas') {
                row.innerHTML = `
                    <td><input type="date" value="${trans.data.split('T')[0]}"></td>
                    <td><select>
                        <option value="">Selecione</option>
                        <option value="Pago" ${trans.status === 'Pago' ? 'selected' : ''}>Pago</option>
                        <option value="Pendente" ${trans.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="Vencido" ${trans.status === 'Vencido' ? 'selected' : ''}>Vencido</option>
                    </select></td>
                    <td><input type="text" value="${trans.fonteOuDescricao}"></td>
                    <td></td>
                    <td></td>
                    <td><input type="text" value="${trans.valor}" oninput="formatCurrency(this); updateDashboard();"></td>
                    <td><select>
                        <option value="pix" ${trans.metodo === 'pix' ? 'selected' : ''}>Pix</option>
                        <option value="dinheiro" ${trans.metodo === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        <option value="cartão débito" ${trans.metodo === 'cartão débito' ? 'selected' : ''}>Cartão Débito</option>
                        <option value="cartão crédito" ${trans.metodo === 'cartão crédito' ? 'selected' : ''}>Cartão Crédito</option>
                    </select></td>
                    <td><input type="text" value="${trans.notas}"></td>
                    <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
                `;
                // Adicionar timestamp ao input de data
                if (trans.timestamp) {
                    row.cells[0].querySelector('input').setAttribute('data-timestamp', trans.timestamp);
                }
                
                const categoryCell = row.cells[3];
                const categorySelect = createCategorySelect('despesas');
                categorySelect.value = trans.categoria || '';
                categoryCell.appendChild(categorySelect);
                const subcategoryCell = row.cells[4];
                const subcategorySelect = createSubcategorySelect(trans.categoria, 'despesas');
                subcategorySelect.value = trans.subcategoria || '';
                subcategoryCell.appendChild(subcategorySelect);
                categorySelect.addEventListener('change', () => {
                    subcategorySelect.innerHTML = '';
                    const subs = subcategoriesMap.despesas[categorySelect.value] || [];
                    subs.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub;
                        opt.textContent = sub;
                        subcategorySelect.appendChild(opt);
                    });
                });
            } else if (tableType === 'despesas-variaveis') {
                row.innerHTML = `
                    <td><input type="date" value="${trans.data.split('T')[0]}"></td>
                    <td><select>
                        <option value="">Selecione</option>
                        <option value="Pago" ${trans.status === 'Pago' ? 'selected' : ''}>Pago</option>
                        <option value="Pendente" ${trans.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="Vencido" ${trans.status === 'Vencido' ? 'selected' : ''}>Vencido</option>
                    </select></td>
                    <td><input type="text" value="${trans.fonteOuDescricao}"></td>
                    <td></td>
                    <td></td>
                    <td><input type="text" value="${trans.valor}" oninput="formatCurrency(this); updateDashboard();"></td>
                    <td><select>
                        <option value="pix" ${trans.metodo === 'pix' ? 'selected' : ''}>Pix</option>
                        <option value="dinheiro" ${trans.metodo === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        <option value="cartão débito" ${trans.metodo === 'cartão débito' ? 'selected' : ''}>Cartão Débito</option>
                        <option value="cartão crédito" ${trans.metodo === 'cartão crédito' ? 'selected' : ''}>Cartão Crédito</option>
                    </select></td>
                    <td><input type="text" value="${trans.notas}"></td>
                    <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
                `;
                // Adicionar timestamp ao input de data
                if (trans.timestamp) {
                    row.cells[0].querySelector('input').setAttribute('data-timestamp', trans.timestamp);
                }
                
                const categoryCell = row.cells[3];
                const categorySelect = createCategorySelect('despesas');
                categorySelect.value = trans.categoria || '';
                categoryCell.appendChild(categorySelect);
                const subcategoryCell = row.cells[4];
                const subcategorySelect = createSubcategorySelect(trans.categoria, 'despesas');
                subcategorySelect.value = trans.subcategoria || '';
                subcategoryCell.appendChild(subcategorySelect);
                categorySelect.addEventListener('change', () => {
                    subcategorySelect.innerHTML = '';
                    const subs = subcategoriesMap.despesas[categorySelect.value] || [];
                    subs.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub;
                        opt.textContent = sub;
                        subcategorySelect.appendChild(opt);
                    });
                });
            }

            // Setar ID da linha
            if (trans.id || trans._id) {
                row.dataset.id = trans.id || trans._id;
            }
        });


        // Adicionar linhas vazias se necessário
        const tables = ['receitas-recorrentes', 'receitas-variaveis', 'despesas-fixas', 'despesas-variaveis'];
        tables.forEach(tableType => {
            const tbody = document.getElementById(`${tableType}-table`).querySelector('tbody');
            const isReceita = tableType.startsWith('receitas');
            let emptyCount = 0;
            
            // Contar linhas vazias usando os mesmos critérios da IA:
            // 1. Descrição vazia (coluna 2)
            // 2. Categoria com valor "Selecione uma categoria" (coluna 4 para receitas, coluna 3 para despesas)
            for (let i = 0; i < tbody.rows.length; i++) {
                const row = tbody.rows[i];
                const descricaoInput = row.cells[2]?.querySelector('input');
                const categoriaSelect = isReceita ? row.cells[4]?.querySelector('select') : row.cells[3]?.querySelector('select');
                
                const descricaoVazia = descricaoInput && descricaoInput.value.trim() === '';
                const categoriaPadrao = categoriaSelect && categoriaSelect.value === 'Selecione uma categoria';
                
                if (descricaoVazia && categoriaPadrao) emptyCount++;
            }
            
            // Adicionar linhas vazias até chegar a 3
            const toAdd = Math.max(0, 3 - emptyCount);
            for (let i = 0; i < toAdd; i++) {
                addRow(tableType);
            }
        });

        tables.forEach(tableType => {
            sortTable(`${tableType}-table`, 'date-desc');
        });

        updateDashboard();
    } catch (error) {
        console.error('Erro ao carregar transações do mês:', error);
    }
}


async function initializeFinances() {
    updateMonthDisplay(); // Atualizar display do mês
    await loadTransactionsForMonth(); // Carregar do mês atual
    collectCategoriesReceitas();
    collectCategoriesDespesas();
    updateDashboard();
}

// Nova função para verificar se há transações
function checkIfHasTransactions() {
    const receitaRecorrenteRows = document.querySelectorAll('#receitas-recorrentes-table tbody tr');
    const receitaVariavelRows = document.querySelectorAll('#receitas-variaveis-table tbody tr');
    const despesaFixaRows = document.querySelectorAll('#despesas-fixas-table tbody tr');
    const despesaVariavelRows = document.querySelectorAll('#despesas-variaveis-table tbody tr');
    
    return receitaRecorrenteRows.length > 0 || 
           receitaVariavelRows.length > 0 || 
           despesaFixaRows.length > 0 || 
           despesaVariavelRows.length > 0;
}

// Função removida: lancarReceitasRecorrentes (não mais necessária sem 'Dia Lançamento')

// Função para adicionar dados fictícios de exemplo (atualizada para separar)
function addExampleData() {
    const receitaRecorrenteTable = document.getElementById('receitas-recorrentes-table').querySelector('tbody');
    const receitaVariavelTable = document.getElementById('receitas-variaveis-table').querySelector('tbody');
    const despesaFixaTable = document.getElementById('despesas-fixas-table').querySelector('tbody');
    const despesaVariavelTable = document.getElementById('despesas-variaveis-table').querySelector('tbody');

    // Adicionar exemplos recorrentes
    const recorrentesExemplo = [
        { data: '2023-10-01', fonte: 'Salário', valor: 'R$ 5.000,00', categoria: 'Salário e Rendimentos do Trabalho', subcategoria: 'Salário fixo', notas: 'Pagamento mensal' },
        { data: '2023-10-05', fonte: 'Freelance regular', valor: 'R$ 1.200,00', categoria: 'Salário e Rendimentos do Trabalho', subcategoria: 'Freelance', notas: 'Mensal' },
        { data: '2023-10-10', fonte: 'Aluguel recebido', valor: 'R$ 800,00', categoria: 'Renda de Aluguéis', subcategoria: 'Aluguel de imóvel residencial', notas: 'Mensal' }
    ];

    recorrentesExemplo.forEach(rec => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="date" value="${rec.data}"></td>
            <td><input type="text" value="${rec.fonte}"></td>
            <td><input type="text" value="${rec.valor}" oninput="formatCurrency(this)"></td>
            <td></td>
            <td></td>
            <td><input type="text" value="${rec.notas}"></td>
            <td><button class="delete-button" onclick="deleteRow(this)">Excluir</button></td>
        `;
        const categoryCell = row.cells[3];
        const categorySelect = createCategorySelect('receitas');
        categorySelect.value = rec.categoria;
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[4];
        const subcategorySelect = createSubcategorySelect(rec.categoria, 'receitas');
        subcategorySelect.value = rec.subcategoria;
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.receitas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
        receitaRecorrenteTable.appendChild(row);
    });

    // Adicionar exemplos variáveis
    const variaveisExemplo = [
        { data: '2023-10-15', fonte: 'Bônus', valor: 'R$ 2.000,00', categoria: 'Salário e Rendimentos do Trabalho', subcategoria: 'Bônus e comissões', notas: 'Bônus anual' },
        { data: '2023-10-20', fonte: 'Venda eventual', valor: 'R$ 500,00', categoria: 'Renda de Empreendimentos', subcategoria: 'Venda de produtos', notas: 'Produto vendido' }
    ];

    variaveisExemplo.forEach(rec => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="date" value="${rec.data}"></td>
            <td><input type="text" value="${rec.fonte}"></td>
            <td><input type="text" value="${rec.valor}" oninput="formatCurrency(this)"></td>
            <td></td>
            <td></td>
            <td><input type="text" value="${rec.notas}"></td>
            <td><button onclick="deleteRow(this)">Excluir</button></td>
        `;
        const categoryCell = row.cells[3];
        const categorySelect = createCategorySelect('receitas');
        categorySelect.value = rec.categoria;
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[4];
        const subcategorySelect = createSubcategorySelect(rec.categoria, 'receitas');
        subcategorySelect.value = rec.subcategoria;
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.receitas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
        receitaVariavelTable.appendChild(row);
    });

    // Adicionar exemplos despesas fixas
    const fixasExemplo = [
        { data: '2023-10-01', descricao: 'Aluguel', categoria: 'Moradia', subcategoria: 'Aluguel', valor: 'R$ 1.500,00', metodo: 'pix', notas: 'Mensal' },
        { data: '2023-10-05', descricao: 'Internet', categoria: 'Moradia', subcategoria: 'Internet residencial', valor: 'R$ 100,00', metodo: 'cartão crédito', notas: 'Mensal' },
        { data: '2023-10-10', descricao: 'Transporte fixo', categoria: 'Transporte', subcategoria: 'Financiamento de veículo', valor: 'R$ 300,00', metodo: 'pix', notas: 'Prestação carro' }
    ];

    fixasExemplo.forEach(desp => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="date" value="${desp.data}"></td>
            <td><input type="text" value="${desp.descricao}"></td>
            <td></td>
            <td></td>
            <td><input type="text" value="${desp.valor}" oninput="formatCurrency(this)"></td>
            <td><select>
                <option value="pix" ${desp.metodo === 'pix' ? 'selected' : ''}>Pix</option>
                <option value="dinheiro" ${desp.metodo === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                <option value="cartão débito" ${desp.metodo === 'cartão débito' ? 'selected' : ''}>Cartão Débito</option>
                <option value="cartão crédito" ${desp.metodo === 'cartão crédito' ? 'selected' : ''}>Cartão Crédito</option>
            </select></td>
            <td><input type="text" value="${desp.notas}"></td>
            <td><button onclick="deleteRow(this)">Excluir</button></td>
        `;
        const categoryCell = row.cells[2];
        const categorySelect = createCategorySelect('despesas');
        categorySelect.value = desp.categoria;
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[3];
        const subcategorySelect = createSubcategorySelect(desp.categoria, 'despesas');
        subcategorySelect.value = desp.subcategoria;
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.despesas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
        despesaFixaTable.appendChild(row);
    });

    // Adicionar exemplos despesas variáveis
    const variaveisDespExemplo = [
        { data: '2023-10-02', descricao: 'Supermercado', categoria: 'Alimentação', subcategoria: 'Supermercado', valor: 'R$ 600,00', metodo: 'cartão débito', notas: 'Compras semanais' },
        { data: '2023-10-03', descricao: 'Combustível', categoria: 'Transporte', subcategoria: 'Combustível', valor: 'R$ 200,00', metodo: 'pix', notas: 'Abastecimento' },
        { data: '2023-10-04', descricao: 'Roupas', categoria: 'Vestuário e Cuidados Pessoais', subcategoria: 'Roupas', valor: 'R$ 150,00', metodo: 'dinheiro', notas: 'Básicas' }
    ];

    variaveisDespExemplo.forEach(desp => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="date" value="${desp.data}"></td>
            <td><input type="text" value="${desp.descricao}"></td>
            <td></td>
            <td></td>
            <td><input type="text" value="${desp.valor}" oninput="formatCurrency(this)"></td>
            <td><select>
                <option value="pix" ${desp.metodo === 'pix' ? 'selected' : ''}>Pix</option>
                <option value="dinheiro" ${desp.metodo === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                <option value="cartão débito" ${desp.metodo === 'cartão débito' ? 'selected' : ''}>Cartão Débito</option>
                <option value="cartão crédito" ${desp.metodo === 'cartão crédito' ? 'selected' : ''}>Cartão Crédito</option>
            </select></td>
            <td><input type="text" value="${desp.notas}"></td>
            <td><button onclick="deleteRow(this)">Excluir</button></td>
        `;
        const categoryCell = row.cells[2];
        const categorySelect = createCategorySelect('despesas');
        categorySelect.value = desp.categoria;
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[3];
        const subcategorySelect = createSubcategorySelect(desp.categoria, 'despesas');
        subcategorySelect.value = desp.subcategoria;
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.despesas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
        despesaVariavelTable.appendChild(row);
    });

    updateDashboard(); // Atualizar dashboard com os exemplos
}

function updateDashboard() {
    const receitaRecorrenteRows = document.querySelectorAll('#receitas-recorrentes-table tbody tr');
    const receitaVariavelRows = document.querySelectorAll('#receitas-variaveis-table tbody tr');
    const despesaFixaRows = document.querySelectorAll('#despesas-fixas-table tbody tr');
    const despesaVariavelRows = document.querySelectorAll('#despesas-variaveis-table tbody tr');

    let totalReceitas = 0;
    let totalDespesas = 0;

    // Somar receitas recorrentes (coluna 3)
    receitaRecorrenteRows.forEach(row => {
        const valor = parseCurrency(row.cells[3].querySelector('input').value);
        totalReceitas += valor;
    });

    // Somar receitas variáveis (coluna 3)
    receitaVariavelRows.forEach(row => {
        const valor = parseCurrency(row.cells[3].querySelector('input').value);
        totalReceitas += valor;
    });

    // Somar despesas fixas (coluna 5)
    despesaFixaRows.forEach(row => {
        const valor = parseCurrency(row.cells[5].querySelector('input').value);
        totalDespesas += valor;
    });

    // Somar despesas variáveis (coluna 5)
    despesaVariavelRows.forEach(row => {
        const valor = parseCurrency(row.cells[5].querySelector('input').value);
        totalDespesas += valor;
    });

    const saldoLiquidoTransacoes = totalReceitas - totalDespesas;

    // Buscar saldo da conta do perfil
    fetch(`http://localhost:3000/profile/${userId}`)
    .then(response => response.json())
    .then(profile => {
        const saldoConta = parseCurrency(profile.financeira?.saldoConta || '0');
        const saldoLiquido = saldoLiquidoTransacoes + saldoConta;

        document.getElementById('saldo-liquido').textContent = formatCurrencyValue(saldoLiquido);
        document.getElementById('total-receitas').textContent = formatCurrencyValue(totalReceitas);
        document.getElementById('total-despesas').textContent = formatCurrencyValue(totalDespesas);
    })
    .catch(error => {
        console.error('Erro ao carregar perfil para dashboard:', error);
        // Fallback sem saldo da conta
        document.getElementById('saldo-liquido').textContent = formatCurrencyValue(saldoLiquidoTransacoes);
        document.getElementById('total-receitas').textContent = formatCurrencyValue(totalReceitas);
        document.getElementById('total-despesas').textContent = formatCurrencyValue(totalDespesas);
    });
    
    // Atualizar dashboard completo se a função existir
    if (typeof updateDashboardSummary === 'function') {
        updateDashboardSummary();
        updateReceitasCategorias();
        updateDespesasCategorias();
        updateDistributionChart();
        updateSubcategoriasReceitasChart();
        updateSubcategoriasDespesasChart();
    }
}

// Funções para as planilhas (atualizada para receitas recorrentes/variáveis e despesas fixas/variáveis)
function addRow(tableType) {
    const today = new Date().toISOString().split('T')[0];
    const table = document.getElementById(`${tableType}-table`).querySelector('tbody');
    const row = table.insertRow();

    if (tableType === 'receitas-recorrentes') {
        row.innerHTML = `
            <td><input type="date" value="${today}"></td>
            <td><select>
                <option value="">Selecione</option>
                <option value="Recebido">Recebido</option>
                <option value="Pendente">Pendente</option>
                <option value="Atrasado">Atrasado</option>
            </select></td>
            <td><input type="text" placeholder="Fonte"></td>
            <td><input type="text" placeholder="Valor" oninput="formatCurrency(this); updateDashboard();"></td>
            <td></td>
            <td></td>
            <td><input type="text" placeholder="Notas"></td>
            <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
        `;
        const statusSelect = row.cells[1].querySelector('select');
        statusSelect.className = 'status-select';
        statusSelect.style.width = '100%';
        statusSelect.style.padding = 'var(--spacing-xs)';
        statusSelect.style.border = '1px solid var(--color-border)';
        statusSelect.style.borderRadius = 'var(--radius-sm)';
        statusSelect.style.background = 'var(--color-background)';
        statusSelect.style.color = 'var(--color-text-primary)';
        
        const categoryCell = row.cells[4];
        const categorySelect = createCategorySelect('receitas');
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[5];
        const subcategorySelect = createSubcategorySelect(categorySelect.value, 'receitas');
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.receitas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
    } else if (tableType === 'receitas-variaveis') {
        row.innerHTML = `
            <td><input type="date" value="${today}"></td>
            <td><select>
                <option value="">Selecione</option>
                <option value="Recebido">Recebido</option>
                <option value="Pendente">Pendente</option>
                <option value="Atrasado">Atrasado</option>
            </select></td>
            <td><input type="text" placeholder="Fonte"></td>
            <td><input type="text" placeholder="Valor" oninput="formatCurrency(this); updateDashboard();"></td>
            <td></td>
            <td></td>
            <td><input type="text" placeholder="Notas"></td>
            <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
        `;
        
        const statusSelect = row.cells[1].querySelector('select');
        statusSelect.className = 'status-select';
        statusSelect.style.width = '100%';
        statusSelect.style.padding = 'var(--spacing-xs)';
        statusSelect.style.border = '1px solid var(--color-border)';
        statusSelect.style.borderRadius = 'var(--radius-sm)';
        statusSelect.style.background = 'var(--color-background)';
        statusSelect.style.color = 'var(--color-text-primary)';
        
        const categoryCell = row.cells[4];
        const categorySelect = createCategorySelect('receitas');
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[5];
        const subcategorySelect = createSubcategorySelect(categorySelect.value, 'receitas');
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.receitas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
    } else if (tableType === 'despesas-fixas') {
        row.innerHTML = `
            <td><input type="date" value="${today}"></td>
            <td><select>
                <option value="">Selecione</option>
                <option value="Pago">Pago</option>
                <option value="Pendente">Pendente</option>
                <option value="Vencido">Vencido</option>
            </select></td>
            <td><input type="text" placeholder="Descrição"></td>
            <td></td>
            <td></td>
            <td><input type="text" placeholder="Valor" oninput="formatCurrency(this); updateDashboard();"></td>
            <td><select>
                <option value="pix">Pix</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="cartão débito">Cartão Débito</option>
                <option value="cartão crédito">Cartão Crédito</option>
            </select></td>
            <td><input type="text" placeholder="Notas"></td>
            <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
        `;
        
        const statusSelect = row.cells[1].querySelector('select');
        statusSelect.className = 'status-select';
        statusSelect.style.width = '100%';
        statusSelect.style.padding = 'var(--spacing-xs)';
        statusSelect.style.border = '1px solid var(--color-border)';
        statusSelect.style.borderRadius = 'var(--radius-sm)';
        statusSelect.style.background = 'var(--color-background)';
        statusSelect.style.color = 'var(--color-text-primary)';
        
        const categoryCell = row.cells[3];
        const categorySelect = createCategorySelect('despesas');
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[4];
        const subcategorySelect = createSubcategorySelect(categorySelect.value, 'despesas');
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.despesas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
    } else if (tableType === 'despesas-variaveis') {
        row.innerHTML = `
            <td><input type="date" value="${today}"></td>
            <td><select>
                <option value="">Selecione</option>
                <option value="Pago">Pago</option>
                <option value="Pendente">Pendente</option>
                <option value="Vencido">Vencido</option>
            </select></td>
            <td><input type="text" placeholder="Descrição"></td>
            <td></td>
            <td></td>
            <td><input type="text" placeholder="Valor" oninput="formatCurrency(this); updateDashboard();"></td>
            <td><select>
                <option value="pix">Pix</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="cartão débito">Cartão Débito</option>
                <option value="cartão crédito">Cartão Crédito</option>
            </select></td>
            <td><input type="text" placeholder="Notas"></td>
            <td><button class="btn-delete" onclick="deleteRow(this)">Excluir</button></td>
        `;
        
        const statusSelect = row.cells[1].querySelector('select');
        statusSelect.className = 'status-select';
        statusSelect.style.width = '100%';
        statusSelect.style.padding = 'var(--spacing-xs)';
        statusSelect.style.border = '1px solid var(--color-border)';
        statusSelect.style.borderRadius = 'var(--radius-sm)';
        statusSelect.style.background = 'var(--color-background)';
        statusSelect.style.color = 'var(--color-text-primary)';
        
        const categoryCell = row.cells[3];
        const categorySelect = createCategorySelect('despesas');
        categoryCell.appendChild(categorySelect);
        const subcategoryCell = row.cells[4];
        const subcategorySelect = createSubcategorySelect(categorySelect.value, 'despesas');
        subcategoryCell.appendChild(subcategorySelect);
        categorySelect.addEventListener('change', () => {
            subcategorySelect.innerHTML = '';
            const subs = subcategoriesMap.despesas[categorySelect.value] || [];
            subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        });
    }
}

// Função para salvar transação no servidor (atualizada)
function saveTransaction(type, row) {
    const cells = row.cells;
    let subType = '';

    if (type === 'receitas-recorrentes') {
        subType = 'recorrente';
    } else if (type === 'receitas-variaveis') {
        subType = 'variavel';
    } else if (type === 'despesas-fixas') {
        subType = 'fixa';
    } else if (type === 'despesas-variaveis') {
        subType = 'variavel';
    }

    const isReceita = type.startsWith('receitas');
    
    // Obter timestamp completo
    const dateInput = cells[0].querySelector('input');
    const dateValue = dateInput.value;
    let timestamp = dateInput.getAttribute('data-timestamp');
    
    // Se não tiver timestamp, criar um novo com a data + hora atual
    if (!timestamp) {
        const [year, month, day] = dateValue.split('-');
        const now = new Date();
        timestamp = new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds()).toISOString();
        dateInput.setAttribute('data-timestamp', timestamp);
    }
    
    const transaction = {
        userId,
        type: isReceita ? 'receitas' : 'despesas',
        subType,
        data: dateValue,
        timestamp: timestamp,
        status: cells[1].querySelector('select').value,
        fonteOuDescricao: cells[2].querySelector('input').value,
        valor: parseFloat((isReceita ? cells[3] : cells[5]).querySelector('input').value.replace(/[^\d,]/g, '').replace(',', '.')),
        categoria: (isReceita ? cells[4] : cells[3]).querySelector('select').value,
        subcategoria: (isReceita ? cells[5] : cells[4]).querySelector('select').value,
        metodo: !isReceita ? (cells[6].querySelector('select')?.value || '') : '',
        notas: (isReceita ? cells[6] : cells[7]).querySelector('input').value
    };

    fetch('http://localhost:3000/save-transaction', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(transaction)
    })
    .then(response => response.text())
    .then(result => console.log(result))
    .catch(error => console.error('Erro ao salvar transação:', error));
}

// Função para atualizar barras de progresso
function updateProgressBars() {
    fetch(`http://localhost:3000/profile/${userId}`)
    .then(response => response.json())
    .then(profile => {
        const objetivos = profile.objetivos || {};
        const fundoMeta = parseFloat(objetivos.fundoEmergencia?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        const longoMeta = parseFloat(objetivos.valorMetaLongo?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;

        const saldoLiquido = parseFloat(document.getElementById('saldo-liquido').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;

        const progressoEmergencia = fundoMeta > 0 ? Math.min((saldoLiquido / fundoMeta) * 100, 100) : 0;
        const progressoLongo = longoMeta > 0 ? Math.min((saldoLiquido / longoMeta) * 100, 100) : 0;

        // Removed: progress bars for minhas-financas are no longer present
        // document.getElementById('progress-emergencia').style.width = progressoEmergencia + '%';
        // document.getElementById('progress-text-emergencia').textContent = `R$ ${saldoLiquido.toFixed(2)} / R$ ${fundoMeta.toFixed(2)}`;

        // document.getElementById('progress-longo').style.width = progressoLongo + '%';
        // document.getElementById('progress-text-longo').textContent = `R$ ${saldoLiquido.toFixed(2)} / R$ ${longoMeta.toFixed(2)}`;
    })
    .catch(error => console.error('Erro ao carregar objetivos:', error));
}

function updateCompactDashboard() {
    const receitaRecorrenteRows = document.querySelectorAll('#receitas-recorrentes-table tbody tr');
    const receitaVariavelRows = document.querySelectorAll('#receitas-variaveis-table tbody tr');
    const despesaFixaRows = document.querySelectorAll('#despesas-fixas-table tbody tr');
    const despesaVariavelRows = document.querySelectorAll('#despesas-variaveis-table tbody tr');

    let totalReceitas = 0;
    let totalDespesas = 0;

    receitaRecorrenteRows.forEach(row => {
        const valor = parseCurrency(row.cells[2].querySelector('input').value);
        totalReceitas += valor;
    });

    receitaVariavelRows.forEach(row => {
        const valor = parseCurrency(row.cells[2].querySelector('input').value);
        totalReceitas += valor;
    });

    despesaFixaRows.forEach(row => {
        const valor = parseCurrency(row.cells[4].querySelector('input').value);
        totalDespesas += valor;
    });

    despesaVariavelRows.forEach(row => {
        const valor = parseCurrency(row.cells[4].querySelector('input').value);
        totalDespesas += valor;
    });

    const saldoLiquidoTransacoes = totalReceitas - totalDespesas;

    // Buscar saldo da conta do perfil
    fetch(`http://localhost:3000/profile/${userId}`)
    .then(response => response.json())
    .then(profile => {
        const saldoConta = parseCurrency(profile.financeira?.saldoConta || '0');
        const saldoLiquido = saldoLiquidoTransacoes + saldoConta;

        document.getElementById('saldo-liquido-compact').textContent = formatCurrencyValue(saldoLiquido);
        document.getElementById('total-receitas-compact').textContent = formatCurrencyValue(totalReceitas);
        document.getElementById('total-despesas-compact').textContent = formatCurrencyValue(totalDespesas);

        const objetivos = profile.objetivos || {};
        const fundoMeta = parseFloat(objetivos.fundoEmergencia?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        const longoMeta = parseFloat(objetivos.valorMetaLongo?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;

        const progressoEmergencia = fundoMeta > 0 ? Math.min((saldoLiquido / fundoMeta) * 100, 100) : 0;
        const progressoLongo = longoMeta > 0 ? Math.min((saldoLiquido / longoMeta) * 100, 100) : 0;

        document.getElementById('progress-emergencia-compact').style.width = progressoEmergencia + '%';
        document.getElementById('progress-longo-compact').style.width = progressoLongo + '%';
    })
    .catch(error => {
        console.error('Erro ao carregar perfil para dashboard compacto:', error);
        // Fallback sem saldo da conta
        document.getElementById('saldo-liquido-compact').textContent = formatCurrencyValue(saldoLiquidoTransacoes);
        document.getElementById('total-receitas-compact').textContent = formatCurrencyValue(totalReceitas);
        document.getElementById('total-despesas-compact').textContent = formatCurrencyValue(totalDespesas);
    });
}

function formatCurrencyValue(value) {
    if (value === null || value === undefined || value === '') return '';
    if (typeof value === 'number') {
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    let str = String(value).trim();
    if (/^[Rr]\$/.test(str)) return str;
    // manter sinais, dígitos, ponto e vírgula; normalizar milhar/decimal
    str = str.replace(/[^\d\-,.]/g, '');
    if (str.indexOf(',') > -1 && str.indexOf('.') > -1) {
        str = str.replace(/\./g, '').replace(',', '.'); // e.g. 1.234,56 => 1234.56
    } else {
        str = str.replace(',', '.'); // 1234,56 => 1234.56
    }
    const num = parseFloat(str);
    if (!Number.isFinite(num)) return '';
    return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function deleteRow(button) {
    const row = button.closest('tr');
    const id = row.dataset.id;
    if (id) {
        fetch(`http://localhost:3000/transaction/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.text())
        .then(result => {
            console.log(result);
            row.remove();
            collectCategoriesReceitas();
            collectCategoriesDespesas();
            updateDashboard();
        })
        .catch(error => console.error('Erro ao deletar transação:', error));
    } else {
        row.remove();
        collectCategoriesReceitas();
        collectCategoriesDespesas();
        updateDashboard();
    }
}

// Funções para o perfil
function saveSection(section) {
    const data = {};
    if (section === 'pessoal') {
        data.nome = document.getElementById('nome').value;
        data.idade = document.getElementById('idade').value;
        data.profissao = document.getElementById('profissao').value;
        data.localizacao = document.getElementById('localizacao').value;
        data.contato = document.getElementById('contato').value;
    } else if (section === 'financeira') {
        data.saldoConta = document.getElementById('saldo-conta').value;
        data.patrimonio = getPatrimonioData();
        data.dependentes = document.getElementById('dependentes').value;
        data.modeloRenda = document.getElementById('modelo-renda').value;
    } else if (section === 'objetivos') {
        data.poupancaMensal = document.getElementById('poupanca-mensal').value;
        data.fundoEmergencia = document.getElementById('fundo-emergencia').value;
        data.prazoEmergencia = document.getElementById('prazo-emergencia').value;
        data.investimentoMensal = document.getElementById('investimento-mensal').value;
        data.metaLongoPrazo = document.getElementById('meta-longo-prazo').value;
        data.valorMetaLongo = document.getElementById('valor-meta-longo').value;
        data.prazoMetaLongo = document.getElementById('prazo-meta-longo').value;
    }

    fetch('http://localhost:3000/save-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, section, data })
    })
    .then(response => response.text())
    .then(result => alert(result))
    .catch(error => console.error('Erro ao salvar perfil:', error));
}

async function loadProfile() {
    try {
        const response = await fetch(`http://localhost:3000/profile/${userId}`);
        const profile = await response.json();
        document.getElementById('nome').value = profile.pessoal?.nome || '';
        document.getElementById('idade').value = profile.pessoal?.idade || '';
        document.getElementById('profissao').value = profile.pessoal?.profissao || '';
        document.getElementById('localizacao').value = profile.pessoal?.localizacao || '';
        document.getElementById('contato').value = profile.pessoal?.contato || '';
        document.getElementById('saldo-conta').value = profile.financeira?.saldoConta || '';
        document.getElementById('dependentes').value = profile.financeira?.dependentes || '';
        document.getElementById('modelo-renda').value = profile.financeira?.modeloRenda || '';
        document.getElementById('poupanca-mensal').value = profile.objetivos?.poupancaMensal || '';
        document.getElementById('fundo-emergencia').value = profile.objetivos?.fundoEmergencia || '';
        document.getElementById('prazo-emergencia').value = profile.objetivos?.prazoEmergencia || '';
        document.getElementById('investimento-mensal').value = profile.objetivos?.investimentoMensal || '';
        document.getElementById('meta-longo-prazo').value = profile.objetivos?.metaLongoPrazo || '';
        document.getElementById('valor-meta-longo').value = profile.objetivos?.valorMetaLongo || '';
        document.getElementById('prazo-meta-longo').value = profile.objetivos?.prazoMetaLongo || '';

        // Carregar patrimônio
        loadPatrimonio(profile.financeira?.patrimonio || []);

        // Carregar dívidas
        await loadDividas();
    } catch (error) {
        console.error('Erro ao carregar perfil:', error);
    }
}

// Remover event listeners de hover e adicionar para o botão flutuante
document.addEventListener('DOMContentLoaded', () => {
    // Botão flutuante
    document.getElementById('ai-float-btn').addEventListener('click', () => {
        openModal();
    });

    // Carregar dívidas ao iniciar
    loadDividas();

    // Event listener para o formulário de dívidas
    document.getElementById('divida-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const valorTotal = parseCurrency(document.getElementById('divida-valor-total').value);
        const numParcelas = parseInt(document.getElementById('divida-parcelas').value);
        const valorParcela = valorTotal / numParcelas;
        const primeiraParcela = document.getElementById('divida-primeira-parcela').value;
        const diaVencimento = parseInt(document.getElementById('divida-dia-vencimento').value);

        // Gerar array de parcelas
        const parcelas = [];
        for (let i = 0; i < numParcelas; i++) {
            const dataParcela = new Date(primeiraParcela);
            dataParcela.setMonth(dataParcela.getMonth() + i);
            
            // Ajustar para o dia de vencimento
            const ultimoDiaMes = new Date(dataParcela.getFullYear(), dataParcela.getMonth() + 1, 0).getDate();
            dataParcela.setDate(Math.min(diaVencimento, ultimoDiaMes));
            
            parcelas.push({
                numero: i + 1,
                dataVencimento: dataParcela.toISOString().split('T')[0],
                valor: valorParcela,
                pago: false
            });
        }

        const divida = {
            id: editingDividaId || Date.now().toString(),
            nome: document.getElementById('divida-nome').value,
            tipo: document.getElementById('divida-tipo').value,
            valorTotal: document.getElementById('divida-valor-total').value,
            valorParcela: formatCurrencyValue(valorParcela),
            diaVencimento: diaVencimento,
            parcelas: parcelas
        };

        if (editingDividaId) {
            // Atualizar dívida existente - manter parcelas já pagas
            const dividaExistente = dividas.find(d => d.id === editingDividaId);
            if (dividaExistente && dividaExistente.parcelas) {
                // Preservar status de pagamento das parcelas existentes
                divida.parcelas = divida.parcelas.map((parcela, index) => {
                    if (dividaExistente.parcelas[index]) {
                        return { ...parcela, pago: dividaExistente.parcelas[index].pago };
                    }
                    return parcela;
                });
            }
            const index = dividas.findIndex(d => d.id === editingDividaId);
            if (index !== -1) {
                dividas[index] = divida;
            }
        } else {
            // Adicionar nova dívida
            dividas.push(divida);
        }

        await saveDividas();
        renderDividas();
        updateDividasSummary();
        closeDividaModal();
    });
});

// === GERENCIAMENTO DE DÍVIDAS ===

let dividas = [];
let editingDividaId = null;

// Carregar dívidas do servidor
async function loadDividas() {
    if (!userId) {
        return;
    }
    try {
        const response = await fetch(`http://localhost:3000/dividas/${userId}`);
        dividas = await response.json();
        renderDividas();
        updateDividasSummary();
    } catch (error) {
        console.error('Erro ao carregar dívidas:', error);
        dividas = [];
    }
}

// Salvar dívidas no servidor
async function saveDividas() {
    try {
        await fetch('http://localhost:3000/save-dividas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, dividas })
        });
    } catch (error) {
        console.error('Erro ao salvar dívidas:', error);
    }
}

// Abrir modal para adicionar dívida
function openDividaModal(dividaId = null) {
    const modal = document.getElementById('divida-modal');
    const form = document.getElementById('divida-form');
    const title = document.getElementById('divida-modal-title');

    if (dividaId) {
        // Modo edição
        const divida = dividas.find(d => d.id === dividaId);
        if (divida) {
            editingDividaId = dividaId;
            title.textContent = 'Editar Divida';
            document.getElementById('divida-nome').value = divida.nome;
            document.getElementById('divida-tipo').value = divida.tipo;
            document.getElementById('divida-valor-total').value = divida.valorTotal;
            document.getElementById('divida-parcelas').value = divida.parcelas.length;
            document.getElementById('divida-valor-parcela').value = divida.valorParcela;
            document.getElementById('divida-primeira-parcela').value = divida.parcelas[0].dataVencimento;
            document.getElementById('divida-dia-vencimento').value = divida.diaVencimento || 10;
        }
    } else {
        // Modo adição
        editingDividaId = null;
        title.textContent = 'Adicionar Divida';
        form.reset();
        // Set default values
        const hoje = new Date();
        const dataAtual = hoje.toISOString().split('T')[0];
        document.getElementById('divida-primeira-parcela').value = dataAtual;
        document.getElementById('divida-dia-vencimento').value = 10;
    }

    modal.style.display = 'flex';

    // Adicionar event listeners para cálculo automático
    setupAutoCalculation();
}

// Configurar cálculo automático
function setupAutoCalculation() {
    const valorTotalInput = document.getElementById('divida-valor-total');
    const parcelasInput = document.getElementById('divida-parcelas');
    const parcelaOutput = document.getElementById('divida-valor-parcela');

    function calcularAutomaticamente() {
        const valorTotal = parseCurrency(valorTotalInput.value);
        const parcelas = parseInt(parcelasInput.value);

        if (valorTotal > 0 && parcelas > 0) {
            const valorParcela = valorTotal / parcelas;
            parcelaOutput.value = formatCurrencyValue(valorParcela);
        } else {
            parcelaOutput.value = '';
        }
    }

    // Remover listeners anteriores
    valorTotalInput.removeEventListener('input', calcularAutomaticamente);
    parcelasInput.removeEventListener('input', calcularAutomaticamente);

    // Adicionar novos listeners
    valorTotalInput.addEventListener('input', calcularAutomaticamente);
    parcelasInput.addEventListener('input', calcularAutomaticamente);

    // Calcular inicialmente
    calcularAutomaticamente();
}

// Fechar modal
function closeDividaModal() {
    document.getElementById('divida-modal').style.display = 'none';
    editingDividaId = null;
}

// Salvar dívida
// Event listener movido para DOMContentLoaded

// Excluir dívida
function deleteDivida(dividaId) {
    if (confirm('Tem certeza que deseja excluir esta dívida?')) {
        dividas = dividas.filter(d => d.id !== dividaId);
        saveDividas();
        renderDividas();
        updateDividasSummary();
    }
}

// Abrir modal de parcelas
function openParcelasModal(dividaId) {
    const divida = dividas.find(d => d.id === dividaId);
    if (!divida) return;

    const modal = document.getElementById('parcelas-modal');
    document.getElementById('parcelas-modal-title').textContent = divida.nome;
    document.getElementById('parcelas-valor-total').textContent = divida.valorTotal;
    document.getElementById('parcelas-valor-parcela').textContent = divida.valorParcela;
    
    const parcelasPagas = divida.parcelas.filter(p => p.pago).length;
    document.getElementById('parcelas-progresso').textContent = `${parcelasPagas}/${divida.parcelas.length}`;

    const container = document.getElementById('parcelas-list-container');
    container.innerHTML = '';

    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    divida.parcelas.forEach(parcela => {
        const dataParcela = new Date(parcela.dataVencimento);
        dataParcela.setHours(0, 0, 0, 0);
        const diffDias = Math.ceil((dataParcela - hoje) / (1000 * 60 * 60 * 24));

        let statusClass = '';
        let statusText = '';

        if (parcela.pago) {
            statusClass = 'parcela-paga';
            statusText = 'Pago';
        } else if (diffDias < 0) {
            statusClass = 'parcela-atrasada';
            statusText = `Atrasado (${Math.abs(diffDias)} dias)`;
        } else if (diffDias === 0) {
            statusClass = 'parcela-hoje';
            statusText = 'Vence hoje';
        } else if (diffDias <= 3) {
            statusClass = 'parcela-proxima';
            statusText = `Vence em ${diffDias} dias`;
        } else {
            statusText = `Vence em ${diffDias} dias`;
        }

        const parcelaElement = document.createElement('div');
        parcelaElement.className = `parcela-item ${statusClass}`;
        parcelaElement.innerHTML = `
            <div class="parcela-header">
                <span class="parcela-numero">Parcela ${parcela.numero}/${divida.parcelas.length}</span>
                <span class="parcela-valor">${parcela.valor}</span>
            </div>
            <div class="parcela-info-row">
                <span class="parcela-data"><i class="fas fa-calendar"></i> ${formatDate(parcela.dataVencimento)}</span>
                <span class="parcela-status">${statusText}</span>
            </div>
            <div class="parcela-actions">
                ${!parcela.pago ? `<button class="parcela-pagar-btn" onclick="marcarParcelaPaga('${dividaId}', ${parcela.numero - 1})">Marcar como Pago</button>` : '<span class="parcela-pago-badge"><i class="fas fa-check-circle"></i> Pago</span>'}
            </div>
        `;
        container.appendChild(parcelaElement);
    });

    modal.style.display = 'flex';
}

// Fechar modal de parcelas
function closeParcelasModal() {
    document.getElementById('parcelas-modal').style.display = 'none';
}

// Marcar parcela como paga
function marcarParcelaPaga(dividaId, parcelaIndex) {
    const divida = dividas.find(d => d.id === dividaId);
    if (divida && divida.parcelas[parcelaIndex]) {
        divida.parcelas[parcelaIndex].pago = true;
        saveDividas();
        renderDividas();
        updateDividasSummary();
        openParcelasModal(dividaId); // Reabrir para atualizar
    }
}

// Toggle detalhes da dívida (removido - não mais necessário)
function toggleDividaDetails(dividaId) {
    // Agora abre o modal de parcelas
    openParcelasModal(dividaId);
}

// Renderizar lista de dívidas
function renderDividas() {
    const container = document.getElementById('dividas-list');
    container.innerHTML = '';

    if (dividas.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">
                <p>Nenhuma divida cadastrada</p>
                <p>Clique em "Adicionar Divida" para começar</p>
            </div>
        `;
        return;
    }

    dividas.forEach(divida => {
        const parcelasPagas = divida.parcelas.filter(p => p.pago).length;
        const totalParcelas = divida.parcelas.length;
        const percentualPago = Math.round((parcelasPagas / totalParcelas) * 100);
        
        const valorTotal = parseCurrency(divida.valorTotal);
        const valorPago = (valorTotal / totalParcelas) * parcelasPagas;
        const valorRestante = valorTotal - valorPago;

        // Verificar próxima parcela não paga
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const proximaParcelaNaoPaga = divida.parcelas.find(p => !p.pago);
        
        let statusClass = '';
        if (proximaParcelaNaoPaga) {
            const dataParcela = new Date(proximaParcelaNaoPaga.dataVencimento);
            dataParcela.setHours(0, 0, 0, 0);
            const diffDias = Math.ceil((dataParcela - hoje) / (1000 * 60 * 60 * 24));

            if (diffDias < 0) {
                statusClass = 'divida-vencimento-atrasado';
            } else if (diffDias === 0) {
                statusClass = 'divida-vencimento-hoje';
            } else if (diffDias <= 3) {
                statusClass = 'divida-vencimento-proximo';
            }
        }

        const dividaElement = document.createElement('div');
        dividaElement.className = `divida-item ${statusClass}`;
        dividaElement.onclick = function(e) {
            // Não abrir modal se clicar nos botões de ação
            if (e.target.closest('.divida-actions-row')) {
                return;
            }
            openParcelasModal(divida.id);
        };
        dividaElement.innerHTML = `
            <div class="divida-header-row">
                <div class="divida-info-group">
                    <div class="divida-title">${divida.nome}</div>
                    <div class="divida-subtitle">${divida.tipo.charAt(0).toUpperCase() + divida.tipo.slice(1)}</div>
                </div>
                <div class="divida-valores">
                    <div class="divida-valor-total">${divida.valorTotal}</div>
                    <div class="divida-valor-restante">Restante: ${formatCurrencyValue(valorRestante)}</div>
                </div>
                <div class="divida-progresso-info">
                    <div class="divida-percentual">${percentualPago}%</div>
                    <div class="divida-parcelas-texto">${parcelasPagas}/${totalParcelas} pagas</div>
                </div>
            </div>
            <div class="divida-progress-bar">
                <div class="divida-progress-fill" style="width: ${percentualPago}%"></div>
            </div>
            <div class="divida-actions-row">
                <button class="divida-action-btn edit" onclick="event.stopPropagation(); openDividaModal('${divida.id}')" title="Editar">Editar</button>
                <button class="divida-action-btn delete" onclick="event.stopPropagation(); deleteDivida('${divida.id}')" title="Excluir">Excluir</button>
            </div>
        `;

        container.appendChild(dividaElement);
    });
}

// Atualizar resumo das dívidas
function updateDividasSummary() {
    const totalDividas = dividas.reduce((sum, divida) => sum + parseCurrency(divida.valorTotal), 0);
    
    // Calcular valor mensal baseado nas parcelas não pagas do mês atual
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    const parcelasMensais = dividas.reduce((sum, divida) => {
        const parcelasDoMes = divida.parcelas.filter(p => {
            if (p.pago) return false;
            const dataParcela = new Date(p.dataVencimento);
            return dataParcela.getMonth() === mesAtual && dataParcela.getFullYear() === anoAtual;
        });
        const valorMensal = parcelasDoMes.reduce((s, p) => s + p.valor, 0);
        return sum + valorMensal;
    }, 0);

    document.getElementById('total-dividas').textContent = formatCurrencyValue(totalDividas);
    document.getElementById('parcelas-mensais').textContent = formatCurrencyValue(parcelasMensais);
}

// Funções auxiliares
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

function parseCurrency(value) {
    if (!value) return 0;
    // Remove R$, espaços, e converte vírgula para ponto
    const cleanValue = value.toString().replace(/R\$\s?/g, '').replace(/\./g, '').replace(',', '.');
    return parseFloat(cleanValue) || 0;
}

function formatCurrencyValue(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

// Funções para Patrimônio
const patrimonioTipos = [
    'Investimentos em ações',
    'Investimentos em títulos públicos',
    'Casa',
    'Carro',
    'Imóveis alugados',
    'Veículos adicionais',
    'Fundos de investimento',
    'Criptomoedas'
];

function addPatrimonio() {
    const list = document.getElementById('patrimonio-list');
    const item = document.createElement('div');
    item.className = 'patrimonio-item';
    item.innerHTML = `
        <select class="patrimonio-select">
            <option value="">Selecione</option>
            ${patrimonioTipos.map(tipo => `<option value="${tipo}">${tipo}</option>`).join('')}
        </select>
        <input type="text" class="patrimonio-value" placeholder="R$ 0,00" oninput="formatCurrency(this); updatePatrimonioTotal();">
        <button class="delete-patrimonio-btn" onclick="deletePatrimonio(this)">×</button>
    `;
    list.appendChild(item);
}

function deletePatrimonio(button) {
    button.closest('.patrimonio-item').remove();
    updatePatrimonioTotal();
}

function updatePatrimonioTotal() {
    const items = document.querySelectorAll('.patrimonio-item');
    let total = 0;
    items.forEach(item => {
        const valueInput = item.querySelector('.patrimonio-value');
        total += parseCurrency(valueInput.value);
    });
    document.getElementById('patrimonio-total').textContent = formatCurrencyValue(total);
}

function getPatrimonioData() {
    const items = document.querySelectorAll('.patrimonio-item');
    const patrimonio = [];
    items.forEach(item => {
        const select = item.querySelector('.patrimonio-select');
        const valueInput = item.querySelector('.patrimonio-value');
        if (select.value && valueInput.value) {
            patrimonio.push({
                tipo: select.value,
                valor: valueInput.value
            });
        }
    });
    return patrimonio;
}

function loadPatrimonio(patrimonioData) {
    const list = document.getElementById('patrimonio-list');
    list.innerHTML = '';
    patrimonioData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'patrimonio-item';
        div.innerHTML = `
            <select class="patrimonio-select">
                <option value="">Selecione</option>
                ${patrimonioTipos.map(tipo => `<option value="${tipo}" ${tipo === item.tipo ? 'selected' : ''}>${tipo}</option>`).join('')}
            </select>
            <input type="text" class="patrimonio-value" value="${item.valor}" oninput="formatCurrency(this); updatePatrimonioTotal();">
            <button class="delete-patrimonio-btn" onclick="deletePatrimonio(this)">×</button>
        `;
        list.appendChild(div);
    });
    updatePatrimonioTotal();
}

patrimonio.js:
// === GERENCIAMENTO DE PATRIMÔNIO ===

function addPatrimonioItem(tipo = '', valor = '') {
    const container = document.getElementById('patrimonio-list');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'patrimonio-item';
    
    itemDiv.innerHTML = `
        <select class="patrimonio-tipo">
            <option value="">Selecione o tipo</option>
            <option value="casa">Casa/Imóvel</option>
            <option value="carro">Carro/Veículo</option>
            <option value="investimentos">Investimentos</option>
            <option value="poupanca">Poupança</option>
            <option value="outros">Outros</option>
        </select>
        <input type="text" class="patrimonio-valor" placeholder="R$ 0,00" value="${valor}" oninput="formatCurrency(this)">
        <button type="button" class="patrimonio-remove-btn" onclick="removePatrimonioItem(this)">Remover</button>
    `;
    
    // Selecionar o tipo se fornecido
    if (tipo) {
        const select = itemDiv.querySelector('.patrimonio-tipo');
        select.value = tipo;
    }
    
    container.appendChild(itemDiv);
}

function removePatrimonioItem(button) {
    button.closest('.patrimonio-item').remove();
}

function getPatrimonioData() {
    const items = document.querySelectorAll('.patrimonio-item');
    const patrimonio = [];
    
    items.forEach(item => {
        const tipo = item.querySelector('.patrimonio-tipo').value;
        const valor = item.querySelector('.patrimonio-valor').value;
        
        if (tipo && valor) {
            patrimonio.push({ tipo, valor });
        }
    });
    
    return patrimonio;
}

function loadPatrimonio(patrimonioArray) {
    const container = document.getElementById('patrimonio-list');
    container.innerHTML = '';
    
    if (patrimonioArray && patrimonioArray.length > 0) {
        patrimonioArray.forEach(item => {
            addPatrimonioItem(item.tipo, item.valor);
        });
    } else {
        // Adicionar pelo menos um item vazio
        addPatrimonioItem();
    }
}

// Inicializar patrimônio ao carregar página
document.addEventListener('DOMContentLoaded', () => {
    // Verificar se estamos na página de perfil
    if (document.getElementById('patrimonio-list')) {
        // Adicionar um item vazio inicial se não houver nenhum
        if (document.querySelectorAll('.patrimonio-item').length === 0) {
            addPatrimonioItem();
        }
    }
});

style.css:
/* Variáveis CSS */
:root {
    --color-primary: #ffffff;
    --color-secondary: #f4f4f5;
    --color-text-primary: #fff1f1;
    --color-text-secondary: #a0a0a0;
    --color-text-tertiary: #6b7280;
    --color-background: #121212;
    --color-surface: #1e1e1e;
    --color-surface-user: #373636;
    --color-surface-elevated: #252525;
    --color-border: #333333;
    --color-hover: #292929;
    --color-success: #28a745;
    --color-error: #dc3545;
    --color-warning: #ffc107;
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;
    --spacing-2xl: 48px;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4);
    --shadow-md: 0 6px 16px rgba(0, 0, 0, 0.6);
    --shadow-lg: 0 12px 30px rgba(0, 0, 0, 0.8);
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* Estilos globais */
body {
    display: flex;
    margin: 0;
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 16px;
    line-height: 1.65;
    letter-spacing: -0.015em;
    height: 100vh;
    overflow: hidden;
    background: var(--color-background);
    color: var(--color-text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Sidebar */
.sidebar {
    width: 150px;
    background: var(--color-background);
    padding: var(--spacing-lg);
    height: 100vh;
    box-sizing: border-box;
    flex-shrink: 0;
    border-right: 1px solid var(--color-border);
    transition: width var(--transition-slow);
    position: relative;
    display: flex;
    flex-direction: column;
}

.sidebar.collapsed {
    width: 75px;
    padding: var(--spacing-md);
}

.sidebar.collapsed .logo {
    opacity: 0;
    width: 0;
    overflow: hidden;
}

.sidebar.collapsed a {
    justify-content: center;
    padding: 0;
}

.sidebar.collapsed a span {
    display: none;
}

.sidebar-nav a[data-tooltip] {
    position: relative;
}

.sidebar-nav a[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
    background: var(--color-surface);
    color: var(--color-text-primary);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-border);
    margin-left: var(--spacing-sm);
}

.sidebar.collapsed .sidebar-nav a[data-tooltip]:hover::after {
    left: 50%;
    top: 100%;
    transform: translateX(-50%);
    margin-left: 0;
    margin-top: var(--spacing-xs);
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
    height: 40px;
}

.logo {
    height: 32px;
    width: auto;
    transition: opacity var(--transition-base);
}

.toggle-btn {
    background: none;
    border: none;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--color-text-secondary);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
}

.toggle-btn:hover {
    background: var(--color-hover);
    color: var(--color-text-primary);
}

.sidebar-nav {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.sidebar-footer {
    margin-top: auto;
    display: flex;
    justify-content: center;
}

.sidebar-footer a {
    width: 54px;
    height: 50px;
    text-decoration: none;
    padding: 0;
    background: #2525256b;
    color: #f4f4f5;
    font-weight: 400;
    border: 1px solid rgba(255, 255, 255, 0.122);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 14px;
    letter-spacing: -0.006em;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--spacing-md);
}

.sidebar-footer a:hover {
    background: var(--color-hover);
    color: var(--color-text-primary);
}

.sidebar-footer a:active {
    transform: scale(0.98);
}

.sidebar-nav a {
    width: 54px;
    height: 50px;
    text-decoration: none;
    padding: 0;
    background: #2525256b;
    color: #f4f4f5;
    font-weight: 400;
    border: 1px solid rgba(255, 255, 255, 0.122);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 14px;
    letter-spacing: -0.006em;
    display: flex;
    align-items: center;
    align-self: center;
    margin-top: 10px;
    justify-content: center;
}

.sidebar-nav a:hover {
    background: var(--color-hover);
    color: var(--color-text-primary);
}

.sidebar-nav a:active {
    transform: scale(0.98);
}

/* Content e páginas */
.content {
    flex: 1;
    height: 100vh;
    box-sizing: border-box;
    overflow: hidden;
    background: var(--color-background);
}

.page-section {
    display: none;
    height: 100%;
    padding-left: 1px;
    padding-right: 0px;
    box-sizing: border-box;
    overflow: auto;
}

.page-section.active {
    display: block;
}

.page-section::-webkit-scrollbar {
    width: 8px;
}

.page-section::-webkit-scrollbar-track {
    background: transparent;
}

.page-section::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

.page-section::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
}

/* Chat */
.chat-container {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-sm);
    margin-bottom: 80px;
    box-sizing: border-box;
}

.chat-input {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    display: flex;
    padding: var(--spacing-md);
    background: var(--color-background);
    box-sizing: border-box;
}

.chat-input input {
    flex: 1;
    padding: var(--spacing-sm) calc(var(--spacing-lg) + 60px) var(--spacing-sm) var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text-primary);
    font-size: 14px;
    height: 100px;
    box-sizing: border-box;
    box-shadow: var(--shadow-sm);
}

.chat-input input:focus {
    outline: none;
    border-color: var(--color-primary);
    background: var(--color-background);
}

.chat-input input:-webkit-autofill {
    -webkit-box-shadow: 0 0 0 1000px var(--color-background) inset;
    -webkit-text-fill-color: var(--color-text-primary);
}

.chat-input button {
    position: absolute;
    right: var(--spacing-lg);
    top: 50%;
    transform: translateY(-50%);
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-secondary);
    color: var(--color-background);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    height: 30px;
}

.chat-input button:hover {
    background: var(--color-hover);
}

.message {
    margin-bottom: var(--spacing-sm);
    padding: var(--spacing-sm);
    border-radius: var(--radius-md);
    max-width: 70%;
}

.message.user {
    background: var(--color-surface-user);
    align-self: flex-end;
    margin-left: auto;
}

.message.bot {
    background: var(--color-surface);
}

.thinking i {
    margin-right: var(--spacing-xs);
    color: var(--color-text-secondary);
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-secondary);
}

/* Modal de Login */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    display: flex;
    width: 52%;
    height: 78%;
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

.modal-left {
    flex: 1;
    background: var(--color-surface-elevated);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-left img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-md) 0 0 var(--radius-md);
}

.modal-right {
    flex: 1;
    padding: var(--spacing-xl);
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    text-align: center;
    color: var(--color-text-primary);
    overflow-y: auto;
}

.modal-right h2 {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-lg);
    font-size: 1.5em;
    font-weight: 500;
}

.modal-right form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.modal-right input {
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text-primary);
    font-size: 1em;
    box-sizing: border-box;
    width: 100%;
}

.modal-right input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

.modal-right button {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-primary);
    color: var(--color-background);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 1em;
    font-weight: 500;
}

.modal-right button:hover {
    background: var(--color-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.modal-right #register-btn {
    background: transparent;
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
}

.modal-right #register-btn:hover {
    background: var(--color-hover);
    color: var(--color-text-primary);
}

#message {
    margin-top: var(--spacing-md);
    color: #ff6b6b;
    font-size: 0.9em;
}

.flatpickr-calendar {
    background: var(--color-surface) !important;
    border: 1px solid var(--color-border) !important;
    border-radius: var(--radius-md) !important;
    box-shadow: var(--shadow-lg) !important;
    color: var(--color-text-primary) !important;
}

.flatpickr-calendar .flatpickr-day {
    color: var(--color-text-primary) !important;
    background: transparent !important;
    border-radius: var(--radius-sm) !important;
}

.flatpickr-calendar .flatpickr-day:hover {
    background: var(--color-hover) !important;
    color: var(--color-text-primary) !important;
}

.flatpickr-calendar .flatpickr-day.selected {
    background: var(--color-primary) !important;
    color: var(--color-background) !important;
}

.flatpickr-calendar .flatpickr-day.today {
    border-color: var(--color-primary) !important;
}

.flatpickr-calendar .flatpickr-months .flatpickr-month {
    background: var(--color-surface) !important;
    color: var(--color-text-primary) !important;
}

.flatpickr-calendar .flatpickr-months .flatpickr-prev-month,
.flatpickr-calendar .flatpickr-months .flatpickr-next-month {
    color: var(--color-text-secondary) !important;
}

.flatpickr-calendar .flatpickr-months .flatpickr-prev-month:hover,
.flatpickr-calendar .flatpickr-months .flatpickr-next-month:hover {
    color: var(--color-text-primary) !important;
}

.flatpickr-calendar .flatpickr-weekdays {
    background: var(--color-surface-elevated) !important;
}

.flatpickr-calendar .flatpickr-weekday {
    color: var(--color-text-secondary) !important;
    background: transparent !important;
}

.flatpickr-calendar .flatpickr-innerContainer {
    background: var(--color-surface) !important;
}

/* ...existing code... */
.month-selector {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-sm);
    background: transparent;
    border-radius: var(--radius-sm);
    margin-bottom: 0;
}

.month-selector button {
    padding: var(--spacing-xs) var(--spacing-sm);
    background: transparent;
    color: var(--color-text-secondary);
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 0.9em;
}

.month-selector button:hover {
    background: var(--color-hover);
    color: var(--color-text-primary);
    border-color: var(--color-border);
}

#current-month-display {
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: 0.9em;
}



/* Modal de IA */
#ai-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--color-surface);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--color-border);
    z-index: 1000;
    max-width: 700px;
    width: 100%;
    text-align: center;
}

#ai-modal h3 {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-md);
    font-size: 1.2em;
}

#ai-modal p {
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
    font-size: 0.9em;
}

#ai-modal input {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-background);
    color: var(--color-text-primary);
    box-sizing: border-box;
    margin-bottom: var(--spacing-md);
    font-size: 0.9em;
    height: 150px; /* Aumentado para 200% (de ~30px para 60px) */
    resize: vertical; /* Permite redimensionar verticalmente se necessário */
}

#ai-modal input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

#ai-modal .button-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-md);
}

#ai-modal button {
    padding: var(--spacing-sm) var(--spacing-md);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 0.9em;
    font-weight: 500;
    width: 45%; /* Largura fixa para garantir lado a lado */
    /* Removido flex: 1; e max-width para evitar conflitos */
}

#ai-submit {
    background: var(--color-primary);
    color: var(--color-background);
}

#ai-submit:hover {
    background: var(--color-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

#close-modal {
    background: var(--color-border);
    color: var(--color-text-primary);
}

#close-modal:hover {
    background: var(--color-hover);
    color: var(--color-text-primary);
}

#ai-loading {
    color: var(--color-text-secondary);
    font-size: 0.9em;
    margin-top: var(--spacing-md);
}

/* Botão flutuante */
#ai-float-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    background: var(--color-primary);
    color: var(--color-background);
    border: none;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    font-size: 14px;
    transition: all var(--transition-fast);
}

#ai-float-btn:hover {
    background: var(--color-hover);
    transform: scale(1.05);
}

#ai-modal input:disabled {
    background: var(--color-border);
    color: var(--color-text-tertiary);
    cursor: not-allowed;
}

#ai-modal select {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-background);
    color: var(--color-text-primary);
    box-sizing: border-box;
    margin-bottom: var(--spacing-md);
    font-size: 0.9em;
    cursor: pointer;
}

#ai-modal select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

#ai-modal select option {
    background: var(--color-surface);
    color: var(--color-text-primary);
}

/* Modal de IA */
#ai-modal #table-select,
#ai-modal #input-section {
    transition: opacity 0.3s ease;
}

#ai-modal #input-section {
    opacity: 0;
}

#ai-modal textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-background);
    color: var(--color-text-primary);
    box-sizing: border-box;
    margin-bottom: var(--spacing-md);
    font-size: 0.9em;
    height: 150px;
    resize: vertical;
    font-family: inherit;
}

#ai-modal textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

#ai-modal textarea:disabled {
    background: var(--color-border);
    color: var(--color-text-tertiary);
    cursor: not-allowed;
}

#ai-modal textarea::-webkit-scrollbar {
    width: 8px;
}

#ai-modal textarea::-webkit-scrollbar-track {
    background: transparent;
}

#ai-modal textarea::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

#ai-modal textarea::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
}

style-core.js:
/* Finanças */
.financas-section {
    padding: var(--spacing-lg);
    background: var(--color-background);
}

.financas-section h2 {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-lg);
}

.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.dashboard-card {
    background: var(--color-surface);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    text-align: center;
}

.dashboard-card h3 {
    color: var(--color-text-secondary);
    font-size: 0.9em;
    margin-bottom: var(--spacing-sm);
}

.dashboard-card p {
    color: var(--color-text-primary);
    font-size: 1.2em;
    font-weight: bold;
}

.dashboard-extra {
    display: flex;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.progress-section {
    grid-column: 1 / -1;
}

.progress-section h3, .recent-transactions h3 {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-md);
}

.progress-item {
    margin-bottom: var(--spacing-md);
}

.progress-item label {
    display: block;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-xs);
}

.progress-items-container {
    display: flex;
    gap: var(--spacing-lg);
    justify-content: space-between;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: var(--color-border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--color-primary);
    transition: width var(--transition-base);
}

.progress-item span {
    display: block;
    margin-top: var(--spacing-xs);
    font-size: 0.9em;
    color: var(--color-text-secondary);
}

.recent-transactions ul {
    list-style: none;
    padding: 0;
}

.recent-transactions li {
    padding: var(--spacing-xs) 0;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text-primary);
}

.recent-transactions li:last-child {
    border-bottom: none;
}

/* Planilhas */
.spreadsheets {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
}

.spreadsheet-group {
    display: flex;
    align-items: stretch;
    gap: 50px;
    overflow-x: auto;
}

.spreadsheet-group::-webkit-scrollbar {
    height: 8px;
}

.spreadsheet-group::-webkit-scrollbar-track {
    background: transparent;
}

.spreadsheet-group::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

.spreadsheet-group::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
}

.spreadsheet {
    display: flex;
    flex-direction: column;
    flex: 0 0 auto;
}

/* Responsividade para telas menores */
@media (max-width: 1200px) {
    .spreadsheet-group {
        gap: 100px;
    }

    #receitas-recorrentes-table th:nth-child(2),
    #receitas-recorrentes-table td:nth-child(2),
    #receitas-variaveis-table th:nth-child(2),
    #receitas-variaveis-table td:nth-child(2),
    #despesas-fixas-table th:nth-child(2),
    #despesas-fixas-table td:nth-child(2),
    #despesas-variaveis-table th:nth-child(2),
    #despesas-variaveis-table td:nth-child(2) {
        width: 120px;
    }

    #receitas-recorrentes-table th:nth-child(3),
    #receitas-recorrentes-table td:nth-child(3),
    #receitas-variaveis-table th:nth-child(3),
    #receitas-variaveis-table td:nth-child(3),
    #despesas-fixas-table th:nth-child(4),
    #despesas-fixas-table td:nth-child(4),
    #despesas-variaveis-table th:nth-child(4),
    #despesas-variaveis-table td:nth-child(4) {
        width: 120px;
    }

    #receitas-recorrentes-table th:nth-child(6),
    #receitas-recorrentes-table td:nth-child(6),
    #receitas-variaveis-table th:nth-child(5),
    #receitas-variaveis-table td:nth-child(5),
    #despesas-fixas-table th:nth-child(7),
    #despesas-fixas-table td:nth-child(7),
    #despesas-variaveis-table th:nth-child(6),
    #despesas-variaveis-table td:nth-child(6) {
        width: 140px;
    }
}

.spreadsheet h3 {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-md);
}

.spreadsheet table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 2px 0;
    background: transparent;
    border: none;
    overflow: hidden;
    table-layout: auto;
}

.spreadsheet::-webkit-scrollbar {
    height: 8px;
}

.spreadsheet::-webkit-scrollbar-track {
    background: transparent;
}

.spreadsheet::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

.spreadsheet::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
}

#receitas-recorrentes-table th:nth-child(1),
#receitas-recorrentes-table td:nth-child(1) {
    width: 115px;
}

#receitas-recorrentes-table th:nth-child(2),
#receitas-recorrentes-table td:nth-child(2) {
    width: 100px; /* Status */
}

#receitas-recorrentes-table th:nth-child(3),
#receitas-recorrentes-table td:nth-child(3) {
    width: 160px; /* Descrição */
}

#receitas-recorrentes-table th:nth-child(4),
#receitas-recorrentes-table td:nth-child(4) {
    width: 110px; /* Valor */
}

#receitas-recorrentes-table th:nth-child(5),
#receitas-recorrentes-table td:nth-child(5) {
    width: 180px; /* Categoria */
}

#receitas-recorrentes-table th:nth-child(6),
#receitas-recorrentes-table td:nth-child(6) {
    width: 180px; /* Subcategoria */
}

#receitas-recorrentes-table th:nth-child(7),
#receitas-recorrentes-table td:nth-child(7) {
    width: 150px; /* Notas */
}

#receitas-recorrentes-table th:nth-child(8),
#receitas-recorrentes-table td:nth-child(8) {
    width: 80px; /* Ações */
}

#receitas-variaveis-table th:nth-child(1),
#receitas-variaveis-table td:nth-child(1) {
    width: 115px;
}

#receitas-variaveis-table th:nth-child(2),
#receitas-variaveis-table td:nth-child(2) {
    width: 100px; /* Status */
}

#receitas-variaveis-table th:nth-child(3),
#receitas-variaveis-table td:nth-child(3) {
    width: 160px; /* Fonte */
}

#receitas-variaveis-table th:nth-child(4),
#receitas-variaveis-table td:nth-child(4) {
    width: 110px; /* Valor */
}

#receitas-variaveis-table th:nth-child(5),
#receitas-variaveis-table td:nth-child(5) {
    width: 180px; /* Categoria */
}

#receitas-variaveis-table th:nth-child(6),
#receitas-variaveis-table td:nth-child(6) {
    width: 180px; /* Subcategoria */
}

#receitas-variaveis-table th:nth-child(7),
#receitas-variaveis-table td:nth-child(7) {
    width: 150px; /* Notas */
}

#receitas-variaveis-table th:nth-child(8),
#receitas-variaveis-table td:nth-child(8) {
    width: 80px; /* Ações */
}

#despesas-fixas-table th:nth-child(1),
#despesas-fixas-table td:nth-child(1) {
    width: 115px;
}

#despesas-fixas-table th:nth-child(2),
#despesas-fixas-table td:nth-child(2) {
    width: 100px; /* Status */
}

#despesas-fixas-table th:nth-child(3),
#despesas-fixas-table td:nth-child(3) {
    width: 160px; /* Descrição */
}

#despesas-fixas-table th:nth-child(4),
#despesas-fixas-table td:nth-child(4) {
    width: 180px; /* Categoria */
}

#despesas-fixas-table th:nth-child(5),
#despesas-fixas-table td:nth-child(5) {
    width: 180px; /* Subcategoria */
}

#despesas-fixas-table th:nth-child(6),
#despesas-fixas-table td:nth-child(6) {
    width: 110px; /* Valor */
}

#despesas-fixas-table th:nth-child(7),
#despesas-fixas-table td:nth-child(7) {
    width: 120px; /* Método */
}

#despesas-fixas-table th:nth-child(8),
#despesas-fixas-table td:nth-child(8) {
    width: 150px; /* Notas */
}

#despesas-fixas-table th:nth-child(9),
#despesas-fixas-table td:nth-child(9) {
    width: 80px; /* Ações */
}

#despesas-variaveis-table th:nth-child(1),
#despesas-variaveis-table td:nth-child(1) {
    width: 115px;
}

#despesas-variaveis-table th:nth-child(2),
#despesas-variaveis-table td:nth-child(2) {
    width: 100px; /* Status */
}

#despesas-variaveis-table th:nth-child(3),
#despesas-variaveis-table td:nth-child(3) {
    width: 160px; /* Descrição */
}

#despesas-variaveis-table th:nth-child(4),
#despesas-variaveis-table td:nth-child(4) {
    width: 180px; /* Categoria */
}

#despesas-variaveis-table th:nth-child(5),
#despesas-variaveis-table td:nth-child(5) {
    width: 180px; /* Subcategoria */
}

#despesas-variaveis-table th:nth-child(6),
#despesas-variaveis-table td:nth-child(6) {
    width: 110px; /* Valor */
}

#despesas-variaveis-table th:nth-child(7),
#despesas-variaveis-table td:nth-child(7) {
    width: 120px; /* Método */
}

#despesas-variaveis-table th:nth-child(8),
#despesas-variaveis-table td:nth-child(8) {
    width: 150px; /* Notas */
}

#despesas-variaveis-table th:nth-child(9),
#despesas-variaveis-table td:nth-child(9) {
    width: 80px; /* Ações */
}

.spreadsheet th,
.spreadsheet td {
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Larguras das colunas (ajuste os valores conforme necessário) */
.spreadsheet th:nth-child(1), /* Data */
.spreadsheet td:nth-child(1) {
    width: 120px; /* Largura para Data */
    min-width: 120px;
}

.spreadsheet th:nth-child(2), /* Fonte/Descrição */
.spreadsheet td:nth-child(2) {
    width: 150px; /* Largura para Fonte/Descrição */
    min-width: 150px;
}

.spreadsheet th:nth-child(3), /* Valor */
.spreadsheet td:nth-child(3) {
    width: 120px; /* Largura para Valor */
    min-width: 120px;
}

.spreadsheet th:nth-child(4), /* Categoria */
.spreadsheet td:nth-child(4) {
    width: 200px; /* Aumentado para Categoria */
    min-width: 200px;
}

.spreadsheet th:nth-child(5), /* Subcategoria */
.spreadsheet td:nth-child(5) {
    width: 200px; /* Aumentado para Subcategoria */
    min-width: 200px;
}

.spreadsheet th:nth-child(6), /* Dia/Notas/Método */
.spreadsheet td:nth-child(6) {
    width: 120px; /* Largura para Dia/Notas/Método */
    min-width: 120px;
}

.spreadsheet th:nth-child(7), /* Notas/Método/Ações */
.spreadsheet td:nth-child(7) {
    width: 150px; /* Largura para Notas/Método/Ações */
    min-width: 150px;
}

.spreadsheet th:nth-child(8), /* Ações */
.spreadsheet td:nth-child(8) {
    width: 80px; /* Largura para Ações */
    min-width: 80px;
}

/* Para tabelas de despesas fixas e variáveis (que têm mais colunas) */
.spreadsheet-group .spreadsheet table th:nth-child(7), /* Dia para fixas */
.spreadsheet-group .spreadsheet table td:nth-child(7) {
    width: 100px;
    min-width: 100px;
}

.spreadsheet-group .spreadsheet table th:nth-child(8), /* Notas para fixas/variáveis */
.spreadsheet-group .spreadsheet table td:nth-child(8) {
    width: 150px;
    min-width: 150px;
}
.spreadsheet th {
    background: transparent;
    font-weight: 500;
    color: var(--color-text-secondary);
    text-align: center;
}

.spreadsheet td input {
    width: 100%;
    padding: var(--spacing-xs);
    border: none;
    border-radius: 0;
    background: transparent;
    color: var(--color-text-primary);
    box-sizing: border-box;
    outline: none;
}

.spreadsheet td input:focus {
    border-bottom: 1px solid var(--color-primary);
}

.spreadsheet td input.category-input {
    padding-right: 30px;
    cursor: pointer;
}

.category-input {
    position: relative;
}

.category-input::after {
    content: '▼';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-secondary);
    pointer-events: none;
    font-size: 12px;
}

.spreadsheet td select {
    width: 100%;
    padding: var(--spacing-xs);
    border: none;
    border-radius: 0;
    background: transparent;
    color: var(--color-text-primary);
    box-sizing: border-box;
    outline: none;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.spreadsheet td select:focus {
    border-bottom: 1px solid var(--color-primary);
}

.spreadsheet button {
    margin-top: auto;
    margin-bottom: 15px;
    width: 250px;
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.spreadsheet button:hover {
    background: var(--color-hover);
    border-color: var(--color-text-secondary);
}

/* Botão de excluir (menor que o botão de adicionar) */
.spreadsheet .btn-delete {
    width: 120px; /* 40% menor que 250px */
    margin: 0;
}

/* Perfil */
.profile-container {
    padding: var(--spacing-lg);
    max-width: 1200px;
    margin: 0 auto;
}

.profile-container h1 {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xl);
}

.profile-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
}

.profile-section {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
}

.profile-section h2 {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-lg);
    font-size: 1.2em;
}

.profile-section label {
    display: block;
    margin-bottom: var(--spacing-sm);
    color: var(--color-text-secondary);
    font-weight: 500;
}

.profile-section input {
    width: 100%;
    padding: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-background);
    color: var(--color-text-primary);
    box-sizing: border-box;
}

.profile-section input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.profile-section button {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-primary);
    color: var(--color-background);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.profile-section button:hover {
    background: var(--color-hover);
}

.patrimonio-container {
    margin-top: var(--spacing-sm);
}

.patrimonio-header {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: var(--spacing-md);
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--color-border);
    font-weight: 500;
    color: var(--color-text-secondary);
    font-size: 0.9em;
}

.patrimonio-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
}

.patrimonio-item {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: var(--spacing-md);
    align-items: center;
}

.patrimonio-item select,
.patrimonio-item input {
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-background);
    color: var(--color-text-primary);
    font-size: 0.9em;
}

.patrimonio-item select:focus,
.patrimonio-item input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.delete-patrimonio-btn {
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    cursor: pointer;
    font-size: 1.2em;
    padding: var(--spacing-xs);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
}

.delete-patrimonio-btn:hover {
    background: rgba(220, 53, 69, 0.1);
    color: var(--color-error);
}

.add-patrimonio-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.9em;
    transition: all var(--transition-fast);
}

.add-patrimonio-btn:hover {
    background: var(--color-hover);
    border-color: var(--color-text-secondary);
}

.patrimonio-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-top: 1px solid var(--color-border);
    font-weight: 600;
    color: var(--color-text-primary);
}

.patrimonio-total label {
    margin: 0;
}

#patrimonio-total {
    font-size: 1.1em;
}

.compact-dashboard {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin-bottom: var(--spacing-md);
    width: 75%;
    margin-left: auto;
    margin-right: auto;
}

.compact-card {
    text-align: center;
    padding: var(--spacing-sm);
    background: var(--color-surface-elevated);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border);
}

.compact-card h4 {
    color: var(--color-text-secondary);
    font-size: 0.8em;
    margin-bottom: var(--spacing-xs);
    font-weight: 500;
}

.compact-card p {
    color: var(--color-text-primary);
    font-size: 1em;
    font-weight: bold;
}

.compact-progress {
    grid-column: 1 / -1;
    padding: var(--spacing-sm);
    background: var(--color-surface-elevated);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border);
}

.progress-item-compact {
    margin-bottom: var(--spacing-sm);
}

.progress-item-compact label {
    display: block;
    color: var(--color-text-secondary);
    font-size: 0.8em;
    margin-bottom: var(--spacing-xs);
}

.progress-bar-compact {
    width: 100%;
    height: 6px;
    background: var(--color-border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--color-primary);
    transition: width var(--transition-base);
}

.category-container {
    position: relative;
    width: 100%;
}

.category-input {
    width: 100%;
    padding: var(--spacing-xs);
    border: none;
    border-radius: 0;
    background: transparent;
    color: var(--color-text-primary);
    box-sizing: border-box;
    outline: none;
}

.category-input:focus {
    border-bottom: 1px solid var(--color-primary);
}

.category-tag {
    display: inline-block;
    padding: 2px 5px;
    background: rgba(255, 255, 255, 0.05);
    color: #000000;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    font-size: 0.9em;
    cursor: pointer;
    position: relative;
    transition: all var(--transition-fast);
}

.category-tag:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
}

.category-remove {
    margin-left: var(--spacing-xs);
    cursor: pointer;
    color: var(--color-background);
    font-weight: bold;
}

.category-remove:hover {
    color: var(--color-text-secondary);
}

.category-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    z-index: 1000;
    max-height: 150px;
    overflow-y: auto;
    list-style: none;
    padding: 0;
    margin: 0;
}

.category-dropdown li {
    padding: var(--spacing-sm);
    cursor: pointer;
    color: var(--color-text-primary);
}

.category-dropdown li:hover {
    background: var(--color-hover);
}

.category-dropdown::-webkit-scrollbar {
    width: 6px;
}

.category-dropdown::-webkit-scrollbar-track {
    background: transparent;
}

.category-dropdown::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
}

.category-dropdown::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
}

.subpage-header {
    display: flex;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-background);
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--spacing-lg);
}

.subpage-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 0.9em;
    font-weight: 500;
}

.subpage-btn:hover {
    background: var(--color-hover);
    color: var(--color-text-primary);
}

.subpage-btn.active {
    background: var(--color-primary);
    color: var(--color-background);
    border-color: var(--color-primary);
}

.subpage {
    display: none;
    height: 100%;
    padding: 0 var(--spacing-lg) var(--spacing-lg) var(--spacing-lg);
    box-sizing: border-box;
    overflow: auto;
}

.subpage.active {
    display: block;
}

.subpage::-webkit-scrollbar {
    width: 8px;
}

.subpage::-webkit-scrollbar-track {
    background: transparent;
}

.subpage::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

.subpage::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
}

/* === SEÇÃO DE DÍVIDAS === */
.dividas-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.dividas-summary {
    display: flex;
    gap: var(--spacing-xl);
}

.summary-item {
    display: flex;
    flex-direction: column;
}

.summary-label {
    font-size: 0.85em;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-xs);
    font-weight: 400;
}

.summary-value {
    font-size: 1.2em;
    font-weight: 600;
    color: var(--color-text-primary);
}

.add-divida-btn {
    background: var(--color-secondary);
    color: var(--color-background);
    border: none;
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    transition: all var(--transition-fast);
}

.add-divida-btn:hover {
    background: var(--color-hover);
    transform: translateY(-1px);
}

/* Lista de Dívidas */
.dividas-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

/* Card de Dívida */
.divida-item {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    transition: all var(--transition-fast);
    cursor: pointer;
}

.divida-item:hover {
    border-color: var(--color-text-secondary);
    box-shadow: var(--shadow-sm);
}

.divida-header-row {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: var(--spacing-lg);
    align-items: start;
    margin-bottom: var(--spacing-md);
}

.divida-info-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.divida-title {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 1em;
    line-height: 1.4;
}

.divida-subtitle {
    font-size: 0.85em;
    color: var(--color-text-secondary);
    font-weight: 400;
}

.divida-valores {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: var(--spacing-xs);
    min-width: 120px;
}

.divida-valor-total {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 1.1em;
}

.divida-valor-restante {
    font-size: 0.85em;
    color: var(--color-text-secondary);
    font-weight: 400;
}

.divida-progresso-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
    min-width: 80px;
}

.divida-percentual {
    font-size: 1.8em;
    font-weight: 700;
    color: var(--color-text-primary);
    line-height: 1;
}

.divida-parcelas-texto {
    font-size: 0.75em;
    color: var(--color-text-secondary);
    font-weight: 400;
    white-space: nowrap;
}

/* Barra de Progresso do Card */
.divida-progress-bar {
    width: 100%;
    height: 6px;
    background: var(--color-surface-elevated);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: var(--spacing-md);
}

.divida-progress-fill {
    height: 100%;
    background: var(--color-secondary);
    border-radius: 3px;
    transition: width 0.3s ease;
}

/* Ações do Card */
.divida-actions-row {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
    padding-top: var(--spacing-sm);
    border-top: 1px solid var(--color-border);
    width: fit-content;
    margin-left: auto;
}

.divida-action-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    font-size: 0.85em;
    font-weight: 500;
    color: var(--color-text-secondary);
}

.divida-action-btn:hover {
    background: var(--color-surface-elevated);
    color: var(--color-text-primary);
}

.divida-action-btn.edit:hover {
    background: rgba(255, 255, 255, 0.05);
}

.divida-action-btn.delete:hover {
    background: rgba(220, 53, 69, 0.1);
    color: var(--color-error);
}

/* Alertas de vencimento */
.divida-vencimento-proximo {
    border-left: 3px solid var(--color-warning);
}

.divida-vencimento-hoje {
    border-left: 3px solid var(--color-error);
}

.divida-vencimento-atrasado {
    border-left: 3px solid var(--color-error);
    background: rgba(220, 53, 69, 0.03);
}

/* === MODAL DE PARCELAS === */
.parcelas-modal-content {
    max-width: 650px;
    width: 90%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    padding: 0;
    background: var(--color-surface);
    border-radius: var(--radius-md);
    overflow: hidden;
}

/* Header do Modal */
.parcelas-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    background: var(--color-surface-elevated);
    border-bottom: 1px solid var(--color-border);
}

.parcelas-modal-header h3 {
    margin: 0;
    font-size: 1.2em;
    font-weight: 600;
    color: var(--color-text-primary);
}

.parcelas-modal-header .close-modal-btn {
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    font-size: 1.8em;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
}

.parcelas-modal-header .close-modal-btn:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
}

/* Body do Modal */
.parcelas-modal-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}

/* Informações Resumo */
.parcelas-info {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    background: var(--color-surface-elevated);
    border-bottom: 1px solid var(--color-border);
}

.parcelas-info-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    text-align: center;
}

.parcelas-info-label {
    font-size: 0.75em;
    color: var(--color-text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.parcelas-info-value {
    font-size: 1.15em;
    font-weight: 700;
    color: var(--color-text-primary);
}

/* Lista de Parcelas */
.parcelas-list {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.parcelas-list::-webkit-scrollbar {
    width: 8px;
}

.parcelas-list::-webkit-scrollbar-track {
    background: transparent;
}

.parcelas-list::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

.parcelas-list::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-secondary);
}

/* Item de Parcela */
.parcela-item {
    background: var(--color-background);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    border-left: 4px solid var(--color-border);
    transition: all var(--transition-fast);
}

.parcela-item:hover {
    border-color: var(--color-text-secondary);
    box-shadow: var(--shadow-sm);
    transform: translateX(2px);
}

/* Estados da Parcela */
.parcela-paga {
    opacity: 0.6;
    border-left-color: var(--color-success);
    background: rgba(40, 167, 69, 0.02);
}

.parcela-paga:hover {
    opacity: 0.7;
}

.parcela-atrasada {
    border-left-color: var(--color-error);
    background: rgba(220, 53, 69, 0.03);
}

.parcela-hoje {
    border-left-color: var(--color-warning);
    background: rgba(255, 193, 7, 0.03);
}

.parcela-proxima {
    border-left-color: var(--color-warning);
}

/* Header da Parcela */
.parcela-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
    padding-bottom: var(--spacing-xs);
    border-bottom: 1px solid var(--color-border);
}

.parcela-numero {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 0.9em;
}

.parcela-valor {
    font-weight: 700;
    color: var(--color-text-primary);
    font-size: 1em;
}

/* Info Row da Parcela */
.parcela-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
    gap: var(--spacing-sm);
}

.parcela-data {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--color-text-secondary);
    font-size: 0.85em;
    font-weight: 400;
}

.parcela-data i {
    font-size: 0.9em;
}

.parcela-status {
    color: var(--color-text-secondary);
    font-size: 0.8em;
    font-weight: 500;
    padding: 4px 10px;
    background: var(--color-surface-elevated);
    border-radius: var(--radius-sm);
    white-space: nowrap;
}

/* Ações da Parcela */
.parcela-actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.parcela-pagar-btn {
    background: var(--color-secondary);
    color: var(--color-background);
    border: none;
    padding: var(--spacing-xs) var(--spacing-lg);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 600;
    transition: all var(--transition-fast);
}

.parcela-pagar-btn:hover {
    background: var(--color-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

.parcela-pago-badge {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--color-success);
    font-weight: 600;
    font-size: 0.85em;
    padding: var(--spacing-xs) var(--spacing-md);
    background: rgba(40, 167, 69, 0.1);
    border-radius: var(--radius-sm);
}

.parcela-pago-badge i {
    font-size: 1em;
}

/* Remover estilos antigos */
.parcelas-summary-row {
    display: none;
}

/* Remover estilos antigos */
.divida-details,
.divida-details.show,
.divida-detail-row,
.divida-detail-label,
.divida-detail-value {
    display: none;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--color-surface-hover);
    border-radius: 4px;
    overflow: hidden;
    margin-top: var(--spacing-xs);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-success), var(--color-primary));
    border-radius: 4px;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.8em;
    color: var(--color-text-tertiary);
    text-align: center;
    margin-top: var(--spacing-xs);
}

/* Modal de Dívidas */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
}

.modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 1001;
    position: relative;
}

/* === MODAL DE DÍVIDAS === */
.divida-modal-content {
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    padding: 0;
    background: var(--color-surface);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.divida-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    background: var(--color-surface-elevated);
    border-bottom: 1px solid var(--color-border);
}

.divida-modal-header h3 {
    margin: 0;
    font-size: 1.2em;
    font-weight: 600;
    color: var(--color-text-primary);
}

.divida-modal-header .close-modal-btn {
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    font-size: 1.8em;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
}

.divida-modal-header .close-modal-btn:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
}

.divida-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    overflow-y: auto;
}

.divida-form::-webkit-scrollbar {
    width: 8px;
}

.divida-form::-webkit-scrollbar-track {
    background: transparent;
}

.divida-form::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.form-group label {
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: 0.85em;
}

.form-group input,
.form-group select {
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-background);
    color: var(--color-text-primary);
    font-size: 0.9em;
    transition: all var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--color-secondary);
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
}

.form-group input[readonly] {
    background: var(--color-surface-elevated);
    cursor: not-allowed;
    opacity: 0.7;
}

.form-actions {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--color-border);
}

.save-divida-btn {
    background: transparent;
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    transition: all var(--transition-fast);
}

.save-divida-btn:hover {
    background: var(--color-surface-elevated);
    border-color: var(--color-text-secondary);
    transform: translateY(-1px);
}

.cancel-btn {
    background: transparent;
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    transition: all var(--transition-fast);
}

.cancel-btn:hover {
    background: var(--color-surface-elevated);
    color: var(--color-text-primary);
    transform: translateY(-1px);
}

/* Responsividade */
@media (max-width: 768px) {
    .dividas-header {
        flex-direction: column;
        gap: var(--spacing-md);
        align-items: stretch;
    }

    .dividas-summary {
        justify-content: space-around;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .divida-header-row {
        padding: var(--spacing-sm);
    }

    .divida-title {
        font-size: 0.9em;
    }

    .divida-actions {
        opacity: 1;
    }
}

/* Alertas de vencimento */
.divida-vencimento-proximo {
    border-left: 4px solid var(--color-warning);
}

.divida-vencimento-hoje {
    border-left: 4px solid var(--color-error);
}

.divida-vencimento-atrasado {
    border-left: 4px solid var(--color-error);
    background: rgba(220, 53, 69, 0.05);
}

server.js:
require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const axios = require('axios');
const path = require('path'); // Adicione para caminhos de arquivo
const app = express();
const port = 3000;

app.use(express.json());
const bcrypt = require('bcrypt');

// Servir arquivos estáticos da pasta client
app.use(express.static(path.join(__dirname, '../client')));

// Definir esquema para usuários
const userSchema = new mongoose.Schema({
  email: { type: String, unique: true, required: true },
  password: { type: String, required: true },
  userId: { type: String, unique: true, required: true }
});

const User = mongoose.model('User', userSchema);


// Conectar ao MongoDB
mongoose.connect(process.env.MONGO_URL)
  .then(() => console.log('Conectado ao MongoDB'))
  .catch(err => console.error('Erro ao conectar ao MongoDB:', err));

// Definir esquemas
const profileSchema = new mongoose.Schema({
  userId: String,
  pessoal: Object,
  financeira: Object,
  objetivos: Object
});

const transactionSchema = new mongoose.Schema({
  userId: String,
  type: String, // 'receitas' ou 'despesas'
  subType: String, // 'recorrente', 'variavel', 'fixa' (para despesas)
  diaLancamento: Number, // Dia do mês para lançamentos recorrentes (1-31)
  ultimoLancamento: Date, // Data do último lançamento automático
  data: Date,
  timestamp: String, // ISO string com hora, minuto e segundo para ordenação precisa
  status: String, // Status da transação: Recebido/Pendente/Atrasado (receitas) ou Pago/Pendente/Vencido (despesas)
  fonteOuDescricao: String,
  valor: Number,
  categoria: String,
  subcategoria: String, // Novo campo
  metodo: String,
  notas: String
});

const Profile = mongoose.model('Profile', profileSchema);
const Transaction = mongoose.model('Transaction', transactionSchema);

// Schema para Anotações
const notesSchema = new mongoose.Schema({
  userId: String,
  notes: Object // Estrutura: { pageNumber: [linha1, linha2, linha3, linha4, linha5] }
});

const Notes = mongoose.model('Notes', notesSchema);


app.post('/register', async (req, res) => {
  const { email, password, nome, nascimento, contato } = req.body;
  try {
    // Validação básica
    if (!email || !password) {
      return res.status(400).json({ message: 'Email e senha são obrigatórios' });
    }

    // Verificar se o email já existe
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ message: 'Usuário já existe' });
    }

    // Hash da senha
    const hashedPassword = await bcrypt.hash(password, 10);

    // Gerar userId único (ex.: UUID)
    const { v4: uuidv4 } = require('uuid');
    const userId = uuidv4();

    // Criar novo usuário
    const newUser = new User({ email, password: hashedPassword, userId });
    await newUser.save();

    // Criar perfil inicial com dados extras
    const initialProfile = {
      userId,
      pessoal: { nome, nascimento, contato },
      financeira: {},
      objetivos: {}
    };
    const profile = new Profile(initialProfile);
    await profile.save();

    res.status(201).json({ message: 'Usuário cadastrado com sucesso', userId });
  } catch (error) {
    console.error('Erro ao cadastrar:', error);
    res.status(500).json({ message: 'Erro ao cadastrar usuário' });
  }
});

// Rota para login
app.post('/login', async (req, res) => {
  const { email, password } = req.body;
  try {
    // Validação básica
    if (!email || !password) {
      return res.status(400).json({ message: 'Email e senha são obrigatórios' });
    }

    // Buscar usuário por email
    const user = await User.findOne({ email });
    if (!user) {
      return res.status(400).json({ message: 'Usuário não encontrado' });
    }

    // Verificar senha
    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      return res.status(400).json({ message: 'Senha incorreta' });
    }

    res.status(200).json({ message: 'Login bem-sucedido', userId: user.userId });
  } catch (error) {
    console.error('Erro ao fazer login:', error);
    res.status(500).json({ message: 'Erro ao fazer login' });
  }
});


// Rota para chat com DeepSeek
app.post('/chat', async (req, res) => {
  const { message, userId } = req.body;
  try {
    // Buscar dados do usuário no MongoDB
    const profile = await Profile.findOne({ userId });
    const transactions = await Transaction.find({ userId }).sort({ data: -1 }).limit(10); // Últimas 10 transações

    // Construir contexto financeiro
    let context = 'Dados financeiros do usuário:\n';
    if (profile) {
      context += `Perfil pessoal: ${JSON.stringify(profile.pessoal)}\n`;
      context += `Situação financeira: ${JSON.stringify(profile.financeira)}\n`;
      context += `Objetivos: ${JSON.stringify(profile.objetivos)}\n`;
    }
    if (transactions.length > 0) {
      context += 'Transações recentes:\n';
      transactions.forEach(t => {
        context += `${t.type}: ${t.fonteOuDescricao} - R$ ${t.valor} (${t.data.toISOString().split('T')[0]})\n`;
      });
    }
    context += '\nMensagem do usuário: ' + message;

    const response = await axios.post('https://api.deepseek.com/v1/chat/completions', {
      model: 'deepseek-chat',
      messages: [{ role: 'user', content: context }],
      max_tokens: 300 // Aumente se necessário
    }, {
      headers: {
        'Authorization': `Bearer ${process.env.DEEPSICK_API}`,
        'Content-Type': 'application/json'
      }
    });
    res.json({ reply: response.data.choices[0].message.content });
  } catch (error) {
    console.error('Erro na API DeepSeek:', error);
    res.status(500).send('Erro ao processar mensagem da IA');
  }
});

app.post('/process-category', async (req, res) => {
  const { description, categories, userId } = req.body;
  try {
      // Validação básica
      if (!description || !categories || !userId) {
        return res.status(400).json({ error: 'Descrição, categorias e userId são obrigatórios' });
      }

      // Prompt para IA escolher categoria
      const prompt = `Baseado na descrição: "${description}". Escolha a categoria mais adequada de: ${categories.join(', ')}. Responda apenas com o nome exato da categoria.`;

      // Chamar IA
      const response = await axios.post('https://api.deepseek.com/v1/chat/completions', {
        model: 'deepseek-chat',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 50 // Limitado para resposta curta
      }, {
        headers: {
          'Authorization': `Bearer ${process.env.DEEPSICK_API}`,
          'Content-Type': 'application/json'
        }
      });

      const category = response.data.choices[0].message.content.trim();
      res.json({ category });
  } catch (error) {
      console.error('Erro ao processar categoria:', error);
      res.status(500).json({ error: 'Erro ao processar categoria com IA' });
  }
});

// Nova rota para processar subcategoria e extrair dados (etapa 2)
app.post('/process-subcategory', async (req, res) => {
  const { description, category, subcategories, userId } = req.body;
  try {
      // Validação básica
      if (!description || !category || !subcategories || !userId) {
        return res.status(400).json({ error: 'Descrição, categoria, subcategorias e userId são obrigatórios' });
      }

      // Obter data atual
      const today = new Date().toISOString().split('T')[0];

      // Determinar se é receita ou despesa baseado na categoria
      const isReceita = req.body.isReceita !== undefined ? req.body.isReceita : true;
      
      // Prompt para IA escolher subcategoria e extrair dados (MODIFICADO para múltiplas transações)
      const prompt = `Hoje é ${today}. Descrição: "${description}". Categoria escolhida: "${category}". Escolha a subcategoria mais adequada de: ${subcategories.join(', ')}. 

IMPORTANTE: Se houver MÚLTIPLAS transações na descrição (ex: "recebi um bônus de 200 e recebi meu salário de 1500"), retorne um ARRAY de objetos JSON, um para cada transação.

Para CADA transação, extraia:
- category: "${category}"
- subcategory: nome da subcategoria mais adequada
- data: formato YYYY-MM-DD (use ${today} se não informado)
- descricao: descrição limpa e resumida
- valor: valor numérico (apenas números, sem "R$" ou símbolos)
- status: ${isReceita ? 'Para RECEITAS, identifique o status. Valores EXATOS possíveis: "Recebido" (se já recebeu/recebeu), "Pendente" (se vai receber/aguardando), "Atrasado" (se atrasado). Use "Recebido" se a descrição indicar que já recebeu (ex: "recebi", "ganhei").' : 'Para DESPESAS, identifique o status. Valores EXATOS possíveis: "Pago" (se já pagou), "Pendente" (se vai pagar/aguardando), "Vencido" (se venceu/atrasado). Use "Pago" se a descrição indicar que já pagou (ex: "paguei", "gastei").'}
- metodo: APENAS para despesas, identifique o método de pagamento. Valores EXATOS possíveis: "pix", "dinheiro", "cartão débito", "cartão crédito". Se não for mencionado, use "pix" como padrão. Para receitas, NÃO inclua este campo.
- notas: informações adicionais relevantes (opcional)

Formato de resposta:
- Se houver MÚLTIPLAS transações: [{"category": "${category}", "subcategory": "...", "data": "...", "descricao": "...", "valor": "...", "status": "...", "metodo": "...", "notas": "..."}, {...}]
- Se houver apenas UMA transação: [{"category": "${category}", "subcategory": "...", "data": "...", "descricao": "...", "valor": "...", "status": "...", "metodo": "...", "notas": "..."}]

Responda APENAS com o array JSON, sem texto adicional.`;

      // Chamar IA
      const response = await axios.post('https://api.deepseek.com/v1/chat/completions', {
        model: 'deepseek-chat',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 500 // Aumentado para suportar múltiplas transações
      }, {
        headers: {
          'Authorization': `Bearer ${process.env.DEEPSICK_API}`,
          'Content-Type': 'application/json'
        }
      });

      // Validar resposta da API
      if (!response.data || !response.data.choices || !response.data.choices[0] || !response.data.choices[0].message) {
        console.error('Resposta da IA inválida:', JSON.stringify(response.data));
        return res.status(500).json({ error: 'Resposta da IA inválida' });
      }

      const rawReply = response.data.choices[0].message.content.trim();
      console.log('Resposta da IA:', rawReply); // Log para debug
      
      // Validar se há conteúdo
      if (!rawReply || rawReply.length === 0) {
        console.warn('Resposta da IA vazia');
        return res.json([{
          data: new Date().toISOString().split('T')[0],
          status: '',
          fonteOuDescricao: description,
          valor: 'R$ 0,00',
          categoria: category,
          subcategoria: subcategories[0] || 'Sem subcategoria',
          notas: 'Processamento manual necessário'
        }]);
      }
      
      // Tentar parsear JSON (agora esperando um array)
      const jsonStart = rawReply.indexOf('[');
      const jsonEnd = rawReply.lastIndexOf(']') + 1;
      
      // Validar se encontrou JSON válido
      if (jsonStart === -1 || jsonEnd === 0 || jsonStart >= jsonEnd) {
        console.warn('Resposta da IA sem JSON válido:', rawReply);
        return res.json([{
          data: new Date().toISOString().split('T')[0],
          status: '',
          fonteOuDescricao: description,
          valor: 'R$ 0,00',
          categoria: 'Sem categoria',
          subcategoria: 'Sem subcategoria',
          notas: 'Processamento manual necessário'
        }]);
      }
      
      const jsonString = rawReply.substring(jsonStart, jsonEnd);
      
      // Tentar fazer o parse com tratamento de erro
      let result;
      try {
        result = JSON.parse(jsonString);
      } catch (parseError) {
        console.error('Erro ao fazer parse do JSON:', jsonString);
        return res.json([{
          data: new Date().toISOString().split('T')[0],
          status: '',
          fonteOuDescricao: description,
          valor: 'R$ 0,00',
          categoria: 'Sem categoria',
          subcategoria: 'Sem subcategoria',
          notas: 'Erro no processamento'
        }]);
      }

      // Garantir que sempre retorne um array
      const resultArray = Array.isArray(result) ? result : [result];

      res.json(resultArray);
  } catch (error) {
      console.error('Erro ao processar subcategoria:', error.message);
      console.error('Stack:', error.stack);
      
      // Retornar resposta padrão em caso de erro
      res.json([{
        data: new Date().toISOString().split('T')[0],
        status: '',
        fonteOuDescricao: description || 'Descrição não disponível',
        valor: 'R$ 0,00',
        categoria: category || 'Sem categoria',
        subcategoria: (subcategories && subcategories[0]) || 'Sem subcategoria',
        notas: 'Erro no processamento - favor preencher manualmente'
      }]);
  }
});

// Rotas para salvar dados
app.post('/save-profile', async (req, res) => {
  try {
    const { userId, section, data } = req.body;
    const update = { [section]: data };
    await Profile.findOneAndUpdate({ userId }, update, { upsert: true, new: true });
    res.status(200).send('Perfil salvo com sucesso');
  } catch (error) {
    res.status(500).send('Erro ao salvar perfil');
  }
});

app.post('/save-transaction', async (req, res) => {
  try {
    const transaction = new Transaction(req.body);
    await transaction.save();
    res.status(200).send('Transação salva com sucesso');
  } catch (error) {
    res.status(500).send('Erro ao salvar transação');
  }
});

// Rota para buscar transações por userId
app.get('/transactions/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const transactions = await Transaction.find({ userId });
    res.json(transactions);
  } catch (error) {
    console.error('Erro ao buscar transações:', error);
    res.status(500).send('Erro ao buscar transações');
  }
});

app.get('/profile/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const profile = await Profile.findOne({ userId });
    res.json(profile || { pessoal: {}, financeira: {}, objetivos: {} });
  } catch (error) {
    console.error('Erro ao buscar perfil:', error);
    res.status(500).send('Erro ao buscar perfil');
  }
});

// Definir esquema para dívidas
const dividaSchema = new mongoose.Schema({
  userId: String,
  dividas: Array
});

const Divida = mongoose.model('Divida', dividaSchema);

// ...existing code...

// Rota para deletar transação por ID
app.delete('/transaction/:id', async (req, res) => {
  try {
    const { id } = req.params;
    await Transaction.findByIdAndDelete(id);
    res.status(200).send('Transação deletada com sucesso');
  } catch (error) {
    console.error('Erro ao deletar transação:', error);
    res.status(500).send('Erro ao deletar transação');
  }
});

// Rotas para dívidas
app.get('/dividas/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const dividaDoc = await Divida.findOne({ userId });
    res.json(dividaDoc?.dividas || []);
  } catch (error) {
    console.error('Erro ao buscar dívidas:', error);
    res.status(500).send('Erro ao buscar dívidas');
  }
});

app.post('/save-dividas', async (req, res) => {
  try {
    const { userId, dividas } = req.body;
    await Divida.findOneAndUpdate(
      { userId },
      { dividas },
      { upsert: true, new: true }
    );
    res.status(200).send('Dívidas salvas com sucesso');
  } catch (error) {
    console.error('Erro ao salvar dívidas:', error);
    res.status(500).send('Erro ao salvar dívidas');
  }
});

// Rotas para Anotações
app.get('/notes/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const notesDoc = await Notes.findOne({ userId });
    res.json(notesDoc || { notes: {} });
  } catch (error) {
    console.error('Erro ao buscar anotações:', error);
    res.status(500).send('Erro ao buscar anotações');
  }
});

app.post('/save-notes', async (req, res) => {
  try {
    const { userId, notes } = req.body;
    await Notes.findOneAndUpdate(
      { userId },
      { notes },
      { upsert: true, new: true }
    );
    res.status(200).send('Anotações salvas com sucesso');
  } catch (error) {
    console.error('Erro ao salvar anotações:', error);
    res.status(500).send('Erro ao salvar anotações');
  }
});

// Rota existente
app.get('/', (req, res) => {
  res.send('Servidor funcionando!');
});

app.listen(port, () => {
  console.log(`Servidor rodando em http://localhost:${port}`);
});